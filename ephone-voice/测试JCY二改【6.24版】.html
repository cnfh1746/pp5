<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('https://files.catbx.moe/yzfk0h.ttf') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html { height: 100%; overflow: hidden; }
        body { height: 100%; overflow: hidden; margin: 0; padding: 20px; font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: normal; background-color: #dcdcdc; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }
        #phone-frame { padding: 12px; background-color: #fff; border-radius: 50px; box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1); position: relative; }       
        .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 130px; height: 28px; background-color: #1f1f1f; border-radius: 0 0 15px 15px; z-index: 20; }
        #phone-screen { width: var(--screen-width); height: var(--screen-height); background-color: #000; border-radius: 40px; position: relative; overflow: hidden; display: flex; flex-direction: column; border: 2px solid #333; }
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        .header .action-btn { font-size: 16px; font-weight: 600; }
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        #world-book-list { flex-grow: 1; overflow-y: auto; background-color: var(--secondary-bg); padding-top: 80px; margin-top: -80px; }
        #chat-list { flex-grow: 1; background-color: var(--secondary-bg); padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; }
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; padding-top: 110px; margin-top: -80px; display: flex; flex-direction: column; gap: 15px; }
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; margin-bottom: 18px; position: relative; }
        .message-wrapper.user { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.ai { align-self: flex-start; align-items: flex-start; }
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        .message-wrapper.ai .sender-name { margin-left: 60px; }
        .message-bubble { display: flex; align-items: flex-start; gap: 19px; position: relative; width: -webkit-fit-content; width: -moz-fit-content; width: fit-content; max-width: 100%; }
        .message-bubble.selected::after { content: '✔'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        .avatar-group { display: flex; flex-direction: column; align-items: center; gap: 5px; flex-shrink: 0; width: 35px;margin-top: -10px; }
        .message-bubble .avatar { width: 34px; height: 34px; border-radius: 20%; object-fit: cover; }
        .message-bubble.ai + .timestamp { position: absolute; bottom: -18px; right: 5px; font-size: 11px; color: #888; text-shadow: 0 0 3px rgba(255,255,255,0.6); }
        .message-bubble.user + .timestamp { position: absolute; bottom: -18px; left: 5px; font-size: 11px; color: #888; text-shadow: 0 0 3px rgba(255,255,255,0.6); }
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); visibility: hidden; }
        #notification-bar.visible { transform: translateX(-50%) translateY(0); visibility: visible; }
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        .checkboxes-container { display: none; position: absolute; top: 100%; margin-top: 5px; left: 0; right: 0; max-height: 150px; overflow-y: auto; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; z-index: 101; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        .checkboxes-container label { display: block; padding: 12px 15px; cursor: pointer; font-weight: normal; color: var(--text-primary); font-size: 15px; }
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration { font-size: var(--chat-font-size, 13px); font-weight: 500; color: var(--text-secondary); }
        .message-bubble.user .voice-duration { color: #3e6224; }
        .message-bubble .content { position: relative; font-size: var(--chat-font-size, 16px); padding: 8px 12px; line-height: 1.5; }
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
        .message-bubble::after { content: ""; position: absolute; width: 20px; height: 20px; background-size: contain; background-repeat: no-repeat; opacity: 1; z-index: 1; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: '🐾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }
        .avatar-with-frame { position: relative; width: 30px; height: 30px; flex-shrink: 0; }
        .avatar-with-frame .avatar-img, .avatar-with-frame .avatar-frame { position: absolute; top: 0; left: 0; width: 150%; height: 150%; }
        .avatar-with-frame .avatar-img { border-radius: 50%; object-fit: cover; z-index: 1; }
        .avatar-with-frame .avatar-frame { z-index: 2; pointer-events: none; }
        .change-frame-btn { padding: 6px 10px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; font-size: 13px; margin-left: 10px; }
        #avatar-frame-modal .modal-content { height: 70%; }
        #avatar-frame-modal .modal-body { padding: 0; display: flex; flex-direction: column; }
        .avatar-with-frame .avatar-frame { position: absolute; width: 52px; height: 52px; top: -7px; left: -4px; }
        .frame-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .frame-tab { flex: 1; padding: 12px; text-align: center; font-weight: 500; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; }
        .frame-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .frame-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .frame-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 15px; }
        .frame-item { aspect-ratio: 1 / 1; border: 2px solid transparent; border-radius: 10px; cursor: pointer; background-color: #f0f0f0; background-size: cover; background-position: center; padding: 5px; transition: all 0.2s ease; position: relative; }
        .frame-item.selected { border-color: var(--accent-color); transform: scale(1.05); }
        .frame-item .preview-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .frame-item .preview-frame { position: absolute; top: -7px; left: 0; width: 100%; height: 100%; }
        #font-preview { transition: font-family 0.3s ease;}
        #chat-list-screen { }
        .chat-list-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 1; }
        .chat-list-view.active { opacity: 1; visibility: visible; z-index: 2; }
        #messages-view { overflow-y: auto; }
        #chat-list-bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; z-index: 15; display: flex; border-top: 1px solid var(--border-color); background-color: rgba(247, 247, 247, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; font-size: 14px; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--accent-color); font-weight: 600; }
        #qzone-screen { background-color: #f0f2f5; }
        .qzone-header { position: relative; z-index: 10; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; text-align: center; }
        .qzone-header .back-btn { font-size: 24px; cursor: pointer; color: var(--accent-color); }
        .qzone-header span:nth-child(2) { position: absolute; left: 50%; transform: translateX(-50%); }
        .qzone-content { flex-grow: 1; overflow-y: auto; }
        .qzone-profile-header { position: relative; margin-bottom: 20px; }
        .qzone-banner-container { width: 100%; height: 180px; position: relative; }
        #qzone-banner-img { width: 100%; height: 100%; object-fit: cover; }
        .qzone-user-info { position: absolute; bottom: -30px; left: 20px; display: flex; align-items: flex-end; gap: 10px; }
        .qzone-avatar-container { position: relative; }
        #qzone-avatar-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); object-fit: cover; }
        #qzone-nickname { font-size: 18px; font-weight: 600; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5); padding-bottom: 5px; }
        .qzone-edit-btn { position: absolute; background-color: rgba(0,0,0,0.4); color: white; border: none; border-radius: 10px; padding: 4px 8px; font-size: 12px; cursor: pointer; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        #change-qzone-banner-btn { bottom: 10px; right: 10px; }
        #change-qzone-avatar-btn { bottom: 5px; right: 5px; }
        #change-qzone-nickname-btn { font-size: 14px; padding: 2px 6px; margin-left: 5px; color: var(--text-primary); background-color: rgba(255,255,255,0.7); border-radius: 5px; position: relative; bottom: 5px; }
        #qzone-banner-container, #qzone-avatar-container, #qzone-nickname { cursor: pointer; transition: opacity 0.2s; }
        #qzone-banner-container:hover, #qzone-avatar-container:hover, #qzone-nickname:hover { opacity: 0.85; }
        .qzone-edit-btn { display: none; }
        #qzone-screen .qzone-header { display: none; }
        #qzone-screen.active .qzone-header { display: flex; }
        #chat-list-screen.in-qzone-view > .header, #chat-list-screen.in-qzone-view > #chat-list-bottom-nav { display: none; }
        .chat-list-item:first-child, .chat-group-container:first-child { margin-top: 10px; }
        .qzone-actions-bar { display: flex; justify-content: space-around; padding: 10px 0; margin: 40px 15px 15px 15px; background-color: var(--secondary-bg); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .action-item { flex: 1; text-align: center; font-size: 15px; font-weight: 500; color: var(--text-primary); cursor: pointer; padding: 8px 0; position: relative; }
        .action-item:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 1px; height: 20px; background-color: var(--border-color); }
        #qzone-posts-list { padding: 0 15px 20px 15px; display: flex; flex-direction: column; gap: 20px; }
        .qzone-post-item { background-color: var(--secondary-bg); border-radius: 12px; padding: 15px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .post-header .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .post-info { display: flex; flex-direction: column; }
        .post-info .post-nickname { font-weight: 600; font-size: 15px; color: var(--text-primary); }
        .post-info .post-timestamp { font-size: 12px; color: var(--text-secondary); }
        .post-content { font-size: 14px; line-height: 1.6; color: #333; white-space: pre-wrap; word-break: break-word; }
        #post-public-text { min-height: 80px; resize: vertical; }
        .post-image-preview-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background-color: #f0f2f5; border: 2px dashed var(--border-color); border-radius: 8px; margin-bottom: 15px; display: none; justify-content: center; align-items: center; }
        .post-image-preview-container.visible { display: flex; }
        #post-image-preview { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 6px; }
        #post-remove-image-btn { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; border-radius: 50%; background-color: #ff3b30; color: white; border: 2px solid white; font-size: 16px; line-height: 20px; text-align: center; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .post-image-upload-options { display: flex; gap: 10px; }
        .post-image-upload-options button { flex: 1; margin-top: 0; }
        .post-mode-switcher { display: flex; margin-bottom: 20px; background-color: #e9ecef; border-radius: 8px; padding: 4px; }
        .mode-btn { flex: 1; padding: 8px; border: none; background-color: transparent; border-radius: 6px; font-size: 14px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease-in-out; }
        .mode-btn.active { background-color: var(--secondary-bg); color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .post-mode-content { display: none; }
        .post-mode-content.active { display: block; }
        .qzone-post-container { position: relative; overflow: hidden; border-radius: 12px; }
        .qzone-post-item { position: relative; z-index: 2; transition: transform 0.3s ease; background-color: var(--secondary-bg); }
        .qzone-post-delete-action { position: absolute; top: 0; right: 0; width: 80px; height: 100%; background-color: #ff3b30; display: flex; justify-content: center; align-items: center; z-index: 1; cursor: pointer; }
        .qzone-post-delete-action span { color: white; font-weight: 500; }
        .qzone-post-item.swiped { transform: translateX(-80px); }
        #album-screen { background-color: #f0f2f5; }
        #album-grid-page { padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .album-item { display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; border-radius: 8px; }
        .album-item:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .album-cover { aspect-ratio: 1 / 1; background-size: cover; background-position: center; border-radius: 8px; margin-bottom: 8px; background-color: #f0f2f5; }
        .album-info { text-align: center; }
        .album-name { font-weight: 500; margin: 0 0 4px 0; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .album-count { font-size: 12px; color: var(--text-secondary); margin: 0; }
        #album-photos-screen { background-color: #f0f2f5; }
        #photos-grid-page { padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .photo-item { position: relative; aspect-ratio: 1 / 1; border-radius: 6px; overflow: hidden; background-color: #e9ecef; }
        .photo-item .photo-thumb { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .photo-item .photo-delete-btn { position: absolute; top: 5px; right: 5px; width: 22px; height: 22px; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; font-size: 16px; line-height: 22px; text-align: center; cursor: pointer; opacity: 0; transition: opacity 0.2s ease; }
        .photo-item:hover .photo-delete-btn { opacity: 1; }
        #photo-viewer-modal { background-color: rgba(0, 0, 0, 0.85); z-index: 1002; -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
        .photo-viewer-content { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        #photo-viewer-image { max-width: 90vw; max-height: 85vh; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); transition: opacity 0.2s ease-in-out; }
        #photo-viewer-close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 40px; font-weight: 200; cursor: pointer; line-height: 1; text-shadow: 0 0 5px black; }
        #photo-viewer-modal .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255, 255, 255, 0.7); font-size: 50px; font-weight: 100; cursor: pointer; padding: 10px; user-select: none; transition: color 0.2s; z-index: 1003; }
        #photo-viewer-prev-btn { left: 5px; }
        #photo-viewer-next-btn { right: 5px; }
        #photo-viewer-modal .nav-arrow:hover { color: white; }
        #photo-viewer-modal .nav-arrow:disabled { color: rgba(255, 255, 255, 0.2); cursor: default; }
        .post-feedback-icons { display: flex; justify-content: flex-end; align-items: center; gap: 12px; padding: 8px 0; }
        .action-icon { cursor: pointer; color: var(--text-secondary); transition: all 0.2s ease-in-out; }
        .action-icon svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .action-icon.active { color: #ff5252; transform: scale(1.1); }
        .action-icon.active.favorite { color: #ffc107; }
        .action-icon.active svg { fill: currentColor; }
        .animate-like { animation: like-bounce 0.4s ease-in-out; }
        @keyframes like-bounce { 0% { transform: scale(1); } 25% { transform: scale(0.8); } 50% { transform: scale(1.2); } 75% { transform: scale(1.05); } 100% { transform: scale(1.1); } }
        .post-footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid #f0f0f0; display: flex; align-items: center; gap: 8px; }
        .comment-section { flex-grow: 1; display: flex; align-items: center; gap: 8px; }
        .comment-section .comment-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .comment-section .comment-input { width: 100%; padding: 8px 12px; border: none; background-color: #f0f2f5; border-radius: 14px; font-size: 13px; outline: none; }
        .comment-send-btn { flex-shrink: 0; padding: 8px 15px; border: none; background-color: var(--accent-color); color: white; border-radius: 14px; font-size: 13px; font-weight: 500; cursor: pointer; }
        .unread-indicator { position: absolute; top: -8px; right: -15px; min-width: 18px; height: 18px; padding: 0 5px; background-color: #ff3b30; color: white; font-size: 11px; font-weight: bold; line-height: 18px; text-align: center; border-radius: 9px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); display: none; z-index: 1; }
        .back-btn-indicator { top: 0; right: -8px; width: 10px; height: 10px; min-width: 10px; padding: 0; border-radius: 50%; }
        .post-comments-container { padding: 10px 0; display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
        .comment-item { line-height: 1.5; }
        .comment-item .commenter-name { font-weight: 600; color: var(--accent-color); cursor: pointer; margin-right: 5px; }
        .comment-item .comment-text { color: var(--text-primary); word-break: break-word; }
        .post-likes-section { display: flex; align-items: center; gap: 6px; padding: 8px 10px; font-size: 13px; color: var(--accent-color); background-color: #f0f5fa; border-top: 1px solid #e9eef3; border-bottom: 1px solid #e9eef3; margin-top: 5px; }
        .post-likes-section .like-icon { width: 16px; height: 16px; fill: currentColor; flex-shrink: 0; }
        .at-mention-popup { position: absolute; bottom: 100%; left: 40px; width: calc(100% - 40px); max-height: 120px; overflow-y: auto; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); z-index: 10; display: none; }
        .at-mention-item { padding: 8px 12px; font-size: 14px; cursor: pointer; color: var(--text-primary); border-bottom: 1px solid #f0f0f0; }
        .at-mention-item:last-child { border-bottom: none; }
        .at-mention-item:hover { background-color: #f5f5f5; }
        #favorites-view { display: flex; flex-direction: column; }
        #favorites-view > .header { flex-shrink: 0; }
        #favorites-list { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .favorite-item-card { background-color: var(--secondary-bg); border-radius: 12px; padding: 15px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); position: relative; }
        .fav-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .fav-card-header .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .fav-card-header .info { flex-grow: 1; }
        .fav-card-header .name { font-weight: 600; font-size: 15px; }
        .fav-card-header .source { font-size: 12px; color: var(--text-secondary); }
        .fav-card-content { font-size: 14px; line-height: 1.6; color: #333; white-space: pre-wrap; word-break: break-word; }
        .fav-card-content .chat-image { margin-top: 8px; }
        .fav-delete-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background: #f0f2f5; border: none; border-radius: 50%; cursor: pointer; font-size: 18px; color: var(--text-secondary); line-height: 28px; text-align: center; }
        .fav-delete-btn:hover { background-color: #e9ecef; color: #ff3b30; }
        .search-bar-container { padding: 10px 15px; background-color: #f9f9f9; position: relative; flex-shrink: 0; }
        #favorites-search-input { width: 100%; padding: 10px 30px 10px 15px; font-size: 14px; border: 1px solid var(--border-color); border-radius: 18px; background-color: var(--secondary-bg); box-sizing: border-box; outline: none; }
        #favorites-search-input:focus { border-color: var(--accent-color); }
        .search-clear-btn { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); background: #ccc; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; font-size: 16px; cursor: pointer; }
        #chat-interface-screen .header .selection-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #chat-interface-screen .selection-controls .action-btn { font-size: 16px; font-weight: 600; cursor: pointer; padding: 5px; }
        #favorites-view.selection-mode .favorite-item-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #favorites-view.selection-mode .favorite-item-card::before { content: ''; position: absolute; left: -25px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; background-color: white; transition: all 0.2s ease; opacity: 0; }
        #favorites-view.selection-mode .favorite-item-card { transform: translateX(35px); }
        #favorites-view.selection-mode .favorite-item-card::before { opacity: 1; }
        #favorites-view.selection-mode .favorite-item-card.selected::before { background-color: var(--accent-color); border-color: var(--accent-color); content: '✔'; color: white; font-size: 14px; text-align: center; line-height: 20px; }
        #favorites-action-bar { position: absolute; bottom: 0; left: 0; right: 0; width: auto; padding: 10px 15px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); background-color: rgba(247, 247, 247, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); box-sizing: border-box; z-index: 5; display: none; }
        #favorites-action-bar .action-bar-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; background-color: #ff3b30; color: white; }
        #chat-interface-screen .header .selection-controls { display: none; }
        #chat-interface-screen .header .default-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #chat-interface-screen.selection-mode .header .default-controls { display: none; }
        #chat-interface-screen.selection-mode .header .selection-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #add-chat-btn, #add-world-book-btn, #create-album-btn-page { font-size: 28px; font-weight: 300; position: relative; top: -1px; }
        #settings-preview-area { width: 100%; height: 180px; background-color: #f0f2f5; border-radius: 8px; padding: 15px; box-sizing: border-box; overflow: hidden; display: flex; flex-direction: column; gap: 10px; border: 1px solid var(--border-color); position: relative; }
        #settings-preview-area::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 1; opacity: 0.8; }
        #settings-preview-area .message-wrapper { position: relative; z-index: 2; }
        #settings-preview-area .message-bubble .avatar { width: 30px; height: 30px; }
        #settings-preview-area .avatar-with-frame { width: 30px; height: 30px; }
        #settings-preview-area .avatar-with-frame .avatar-frame { width: 44px; height: 44px; top: -7px; left: -7px; }
        #settings-preview-area .message-bubble .timestamp { display: none; }
        .existing-group-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); }
        .existing-group-item .group-name { font-weight: 500; }
        .existing-group-item .delete-group-btn { color: #ff3b30; font-size: 20px; cursor: pointer; padding: 5px; }
        .chat-group-container { border-bottom: 1px solid var(--border-color); }
        .chat-group-container:first-child { border-top: 1px solid var(--border-color); }
        .chat-group-header { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; background-color: #f7f7f7; }
        .chat-group-header .arrow { font-size: 14px; margin-right: 8px; transition: transform 0.2s ease; }
        .chat-group-header.collapsed .arrow { transform: rotate(-90deg); }
        .chat-group-header .group-name { font-weight: 600; font-size: 15px; }
        .chat-group-content { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .chat-group-content.collapsed { max-height: 0; }
        .format-helpers { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .format-btn { background-color: #e9ecef; color: var(--text-primary); border: none; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .format-btn:hover { background-color: #dcdfe3; }
        .post-actions-btn { margin-left: auto; padding: 5px 10px; font-size: 20px; font-weight: bold; color: var(--text-secondary); cursor: pointer; border-radius: 50%; line-height: 1; }
        .post-actions-btn:hover { background-color: #f0f0f0; }
        #post-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #post-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        #post-actions-modal #cancel-post-action-btn { margin-top: 8px; border-radius: 8px; background-color: #f0f0f0; }
        #chat-messages .transfer-card .transfer-title, #chat-messages .transfer-card .transfer-amount, #chat-messages .transfer-card .transfer-note { text-shadow: none !important; color: white !important; }
        #chat-messages .transfer-card .transfer-title { font-size: 16px !important; font-weight: 600 !important; }
        #chat-messages .transfer-card .transfer-amount { font-size: 28px !important; font-weight: bold !important; }
        #chat-messages .transfer-card .transfer-note { font-size: 13px !important; opacity: 0.9 !important; }
        #ephone-tts-settings-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        #ephone-tts-settings-panel.visible { display: flex; }
        .ephone-tts-modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; padding: 15px; }
        .ephone-tts-modal-header { font-weight: 600; text-align: center; margin-bottom: 15px; }
        .ephone-tts-modal-body { overflow-y: auto; flex-grow: 1; }
        .ephone-tts-modal-footer { padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; }
        .tts-character-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .tts-character-row label { flex: 1 1 30%; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tts-character-row select { flex: 1 1 70%; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 5px; padding: 6px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="phone-frame">
        <div class="notch"></div>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">星期一, 1月1日</div></div>
                <div id="app-grid">
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg" alt="世界书"></div><span class="label">世界书</span></div>
                        <div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                    </div>
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg" alt="API设置"></div><span class="label">API设置</span></div>
                        <div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg" alt="壁纸"></div><span class="label">壁纸</span></div>
                        <div class="app-icon" onclick="showScreen('font-settings-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/j1kn1a.jpeg" alt="字体"></div>
                            <span class="label">字体</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>世界书</span><span class="action-btn" id="add-world-book-btn">+</span></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‹</span>
                    <span id="world-book-editor-title">编辑世界书</span>
                    <span class="save-btn" id="save-world-book-btn">保存</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">书名</label>
                        <input type="text" id="world-book-name-input" placeholder="请输入世界书的名称...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">内容</label>
                        <textarea id="world-book-content-input" placeholder="在此处输入详细的世界观设定..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen">
                <div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>API 设置</span><span style="width: 30px;"></span></div>
                <div class="form-container">
                    <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">提示: 若要使用“发送图片”功能, 请务必选择支持Vision(视觉)的模型, 如<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>或<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>。</p>
                    <div class="form-group"><label for="proxy-url">反代地址 (不需要添加/v1噢~)</label><input type="text" id="proxy-url" placeholder="例如: https://api.openai.com"></div>
                    <div class="form-group"><label for="api-key">密钥 (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div>
                    <div class="form-group"><label for="model-select">模型</label><select id="model-select"></select></div>
                    <button class="form-button" id="fetch-models-btn">拉取模型</button>
                    <hr style="margin:20px 0; opacity:.3">
                    <div class="form-group">
                        <label>TTS 语音服务 (AI Hobbyist)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="tts-default-voice-select" style="flex-grow: 1;"></select>
                            <button id="tts-refresh-models-btn" class="form-button-secondary" style="margin-top:0; padding: 12px;">刷新</button>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="tts-autoplay-switch" style="margin-bottom: 0;">自动播放语音</label>
                        <input type="checkbox" id="tts-autoplay-switch" style="width: auto; height: 20px;">
                    </div>
                    <hr style="margin:20px 0; opacity:.3">
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="background-activity-switch" style="margin-bottom: 0;">启用后台角色活动<p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">警告：此功能会显著增加API调用和费用！</p></label>
                        <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="background-interval-input" style="margin-bottom: 0;">后台活动检测间隔 (秒)<p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">建议值 60-300。值越大，费用越低，但角色反应越慢。</p></label>
                        <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
                    </div>
                    <button class="form-button" id="save-api-settings-btn">保存设置</button>
                    <hr style="margin:20px 0; opacity:.3">
                    <button class="form-button" id="export-data-btn">导出数据</button>
                    <button class="form-button" id="import-btn">导入备份文件</button>
                    <input id="import-data-input" type="file" accept="application/json" hidden>
                </div>
            </div>

            <div id="chat-list-screen" class="screen">
                <div class="header" id="main-chat-list-header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
                    <span>消息</span>
                    <div class="header-actions">
                        <span class="action-btn" id="add-group-chat-btn" title="创建群聊"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                        <span class="action-btn" id="add-chat-btn">+</span>
                    </div>
                </div>
                <div id="messages-view" class="chat-list-view active">
                    <div id="chat-list"></div>
                </div>
                <div id="qzone-screen" class="chat-list-view">
                    <div class="qzone-header">
                        <span class="back-btn" id="qzone-back-btn">‹</span>
                        <span>好友动态</span>
                    </div>
                    <div class="qzone-content">
                        <div class="qzone-profile-header">
                            <div id="qzone-banner-container" class="qzone-banner-container">
                                <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="背景">
                                <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                            </div>
                            <div class="qzone-user-info">
                                <div id="qzone-avatar-container" class="qzone-avatar-container">
                                    <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="头像">
                                    <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                                </div>
                                <span id="qzone-nickname">{{user}}</span>
                            </div>
                        </div>
                        <div class="qzone-actions-bar">
                            <div class="action-item" id="create-shuoshuo-btn"><span>说说</span></div>
                            <div class="action-item" id="create-post-btn"><span>动态</span></div>
                            <div class="action-item" id="open-album-btn"><span>相册</span></div>
                        </div>
                        <div id="qzone-posts-list"></div>
                    </div>
                </div>
                <div id="favorites-view" class="chat-list-view">
                    <div class="header"> 
                        <span class="back-btn" id="favorites-back-btn">‹</span>
                        <span>我的收藏</span>
                        <span class="action-btn" id="favorites-edit-btn">编辑</span>
                    </div>
                    <div class="search-bar-container">
                        <input type="search" id="favorites-search-input" placeholder="搜索收藏的标题、内容或作者...">
                        <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">×</button>
                    </div>
                    <div id="favorites-list" class="list-container"></div>
                    <div id="favorites-action-bar" style="display: none;">
                        <button id="favorites-delete-selected-btn" class="action-bar-btn">删除 (0)</button>
                    </div>
                </div>
                <div id="chat-list-bottom-nav">
                    <div class="nav-item active" data-view="messages-view"><span>消息</span></div>
                    <div class="nav-item" data-view="qzone-screen"><span>动态</span></div>
                    <div class="nav-item" data-view="favorites-view"><span>收藏</span></div>
                </div>
            </div>
            
            <div id="album-screen" class="screen">
                <div class="header">
                    <span class="back-btn" id="album-back-btn">‹</span>
                    <span>我的相册</span>
                    <span class="action-btn" id="create-album-btn-page">+</span>
                </div>
                <div class="list-container">
                    <div id="album-grid-page"></div>
                </div>
            </div>
            
            <div id="album-photos-screen" class="screen">
                <div class="header">
                    <span class="back-btn" id="album-photos-back-btn">‹</span>
                    <span id="album-photos-title">相册名称</span>
                    <span class="action-btn" id="album-upload-photo-btn">上传</span>
                </div>
                <div class="list-container">
                    <div id="photos-grid-page"></div>
                    <div id="photo-viewer-modal" class="modal">
                        <button id="photo-viewer-close-btn">×</button>
                        <button id="photo-viewer-prev-btn" class="nav-arrow">‹</button>
                        <div class="photo-viewer-content">
                            <img id="photo-viewer-image" src="" alt="全屏照片预览">
                        </div>
                        <button id="photo-viewer-next-btn" class="nav-arrow">›</button>
                    </div>
                </div>
            </div>
            
            <input type="file" id="album-photo-input" accept="image/*" multiple hidden>
            
            <div id="chat-interface-screen" class="screen">
                <div class="header">
                    <div class="default-controls">
                        <span class="back-btn" id="back-to-list-btn">‹</span>
                        <span id="chat-header-title">聊天对象</span>
                        <div class="header-actions">
                            <span class="action-btn" id="tts-settings-btn" title="语音设置">🔊</span>
                            <span class="action-btn" id="listen-together-btn" title="一起听"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="一起听"></span>
                            <span class="action-btn" id="chat-settings-btn" title="聊天设置"><img src="https://i.postimg.cc/R04MT1MV/210-20250618115233.png" alt="设置"></span>
                        </div>
                    </div>
                    <div class="selection-controls">
                        <span id="selection-cancel-btn">取消</span>
                        <span id="selection-count"></span>
                        <div class="header-actions">
                            <span id="selection-favorite-btn" class="action-btn">收藏</span>
                            <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">删除</span>
                        </div>
                    </div>
                </div>
                <div id="chat-messages"><div id="typing-indicator">对方正在输入...</div></div>
                <div id="chat-input-area">
                    <div id="chat-input-actions-top">
                        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="表情面板">+</button>
                        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="发送照片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
                        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="上传图片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="转账">￥</button>
                        <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="发送语音"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
                    </div>
                    <div id="chat-input-main-row">
                        <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
                        <div id="input-actions-wrapper">
                            <button id="wait-reply-btn" title="等待回复"><img src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="等待回复"></button>
                            <button id="send-btn" class="action-button">发送</button>
                        </div>
                    </div>
                </div>
                <div id="sticker-panel">
                    <div id="sticker-panel-header">
                        <span class="panel-btn" id="close-sticker-panel-btn">取消</span>
                        <span class="title">我的表情</span>
                        <div style="display: flex; gap: 10px;">
                            <span class="panel-btn" id="add-sticker-btn">添加</span>
                            <span class="panel-btn" id="upload-sticker-btn">上传</span>
                        </div>
                    </div>
                    <div id="sticker-grid"></div>
                </div>
                <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                <div id="music-player-overlay">
                    <div class="music-player-window">
                        <span id="music-playlist-btn">☰</span>
                        <div id="music-time-counter">已经一起听了0.0小时</div>
                        <div id="music-player-song-title">请添加歌曲</div>
                        <div id="music-player-artist">...</div>
                        <div class="music-controls">
                            <button id="music-prev-btn">◀</button>
                            <button id="music-play-pause-btn" class="play-pause-btn">▶</button>
                            <button id="music-next-btn">▶</button>
                            <button id="music-mode-btn">顺序</button>
                        </div>
                        <div class="music-bottom-actions">
                            <button id="music-exit-btn">退出一起听</button>
                            <button id="music-return-btn">返回聊天</button>
                        </div>
                    </div>
                </div>
                <div id="music-playlist-panel">
                    <div class="playlist-header">
                        <span class="panel-btn" id="close-playlist-btn">返回</span>
                        <span>播放列表</span>
                        <div>
                            <span class="panel-btn" id="add-song-local-btn">本地</span>
                            <span class="panel-btn" id="add-song-url-btn">URL</span>
                        </div>
                    </div>
                    <div class="playlist-body" id="playlist-body"></div>
                </div>
                <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
            </div>
            
            <div id="wallpaper-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>壁纸设置</span><span style="width: 30px;"></span></div><div class="form-container"><div id="wallpaper-preview">点击下方上传</div><button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">上传壁纸</button><input type="file" id="wallpaper-upload-input" accept="image/*"><button class="form-button" id="save-wallpaper-btn">保存并应用</button></div></div>
            
            <div id="font-settings-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
                    <span>字体设置</span>
                    <span style="width: 30px;"></span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="font-url-input">字体文件URL (.ttf, .otf, .woff等)</label>
                        <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
                    </div>
                    <div class="form-group">
                        <label>实时预览</label>
                        <div id="font-preview" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9;">
                            <p style="font-size: 20px; margin: 0 0 10px 0;">你好世界 Hello World</p>
                            <p style="margin: 0;">这是字体预览效果，12345。</p>
                        </div>
                    </div>
                    <button class="form-button" id="save-font-btn">保存并应用</button>
                    <button class="form-button form-button-secondary" id="reset-font-btn">恢复默认字体</button>
                </div>
            </div>
        </div>
    </div>
  
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>聊天设置</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">备注名 / 群名</label><input type="text" id="chat-name-input"></div>
    <div class="form-group" id="assign-group-section" style="display: none;"><label for="assign-group-select">好友分组</label><div style="display: flex; align-items: center; gap: 10px;"><select id="assign-group-select" style="flex-grow: 1;"></select><button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">管理分组</button></div></div>
    <div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">我的群昵称</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>群头像</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">上传群头像</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
    <div class="form-group" id="world-book-link-group"><label>关联世界书 (可多选)</label><div class="custom-multiselect"><div class="select-box"><span class="selected-options-text">-- 点击选择 --</span><span class="arrow-down">▼</span></div><div id="world-book-checkboxes-container" class="checkboxes-container"></div></div></div>
    <div class="form-group" id="ai-persona-group"><label for="ai-persona">对方人设 (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>对方头像</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">上传对方头像</button><button class="change-frame-btn" data-type="ai">更换头像框</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">我的人设 (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>我的头像</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">上传我的头像</button><button class="change-frame-btn" data-type="my">更换头像框</button><button id="open-persona-library-btn">预设</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>群成员人设</label><div id="group-members-settings"></div></div><div class="form-group"><label for="max-memory">上下文记忆条数</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>聊天气泡主题 <button id="reset-theme-btn" type="button">重置</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> 默认</label><label><input type="radio" name="theme-select" value="pink_blue"> 粉蓝</label><label><input type="radio" name="theme-select" value="blue_white"> 蓝白</label><label><input type="radio" name="theme-select" value="purple_yellow"> 紫黄</label><label><input type="radio" name="theme-select" value="black_white"> 黑白</label><label><input type="radio" name="theme-select" value="yellow_white"> 黄白</label><label><input type="radio" name="theme-select" value="red_black"> 红黑</label><label><input type="radio" name="theme-select" value="blue_yellow"> 蓝黄</label><label><input type="radio" name="theme-select" value="pink_yellow"> 粉黄</label><label><input type="radio" name="theme-select" value="pink_purple"> 粉紫</label><label><input type="radio" name="theme-select" value="gray_white"> 灰白</label><label><input type="radio" name="theme-select" value="blue_green"> 蓝绿</label><label><input type="radio" name="theme-select" value="pink_white"> 粉白</label><label><input type="radio" name="theme-select" value="pink_black"> 粉黑</label><label><input type="radio" name="theme-select" value="pink_green"> 粉绿</label><label><input type="radio" name="theme-select" value="green_black"> 绿黑</label></div></div>
    <div class="form-group"><label for="font-size-slider">聊天字体大小 <span id="font-size-value">13px</span></label><input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;"></div>
    <div class="form-group"><label for="custom-css-input">自定义气泡样式 (CSS)<button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button></label><textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder=""></textarea></div>
    <div class="form-group"><label>实时预览</label><div id="settings-preview-area"></div></div>
    <div class="form-group"><label>聊天背景</label><div class="bg-upload-container"><button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">上传背景图</button><button type="button" id="remove-bg-btn">移除背景</button></div><img id="bg-preview" class="bg-preview-img"><input type="file" id="bg-input" accept="image/*" style="display: none;"></div>
    <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="clear-chat-btn">清空聊天记录</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">取消</button><button class="save" id="save-chat-settings-btn">保存</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>我的人设库</span><button id="add-persona-preset-btn" class="action-button">添加</button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">关闭</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">添加人设预设</span></div><div class="modal-body"><div class="form-group"><label>预设头像</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">上传头像</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">预设人设</label><textarea id="preset-persona-input" rows="4" placeholder="在此输入这个人设的详细设定..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">取消</button><button class="save" id="save-persona-preset-btn">保存</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>编辑群成员</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">名字</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">人设</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>头像</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">上传头像</button><button class="change-frame-btn" data-type="member">更换头像框</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">取消</button><button class="save" id="save-member-settings-btn">保存</button></div></div></div>
    
    <div id="custom-modal-overlay"><div id="custom-modal"><div class="custom-modal-header" id="custom-modal-title"></div><div class="custom-modal-body" id="custom-modal-body"></div><div class="custom-modal-footer"><button id="custom-modal-cancel">取消</button><button id="custom-modal-confirm" class="confirm-btn">确定</button></div></div></div>
    
    <div id="preset-actions-modal" class="modal"><div id="custom-modal" style="width: 250px;"><div class="custom-modal-footer"><button id="preset-action-edit">编辑预设</button><button id="preset-action-delete" class="btn-danger">删除预设</button><button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button></div></div></div>

    <div id="transfer-modal"><div class="transfer-content"><div class="transfer-header">给Ta一个惊喜！</div><div class="transfer-input-group"><label for="transfer-amount">转账金额</label><input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01"></div><div class="transfer-input-group"><label for="transfer-note">备注 (可选)</label><input type="text" id="transfer-note" placeholder="留下你的小心思~" maxlength="20"></div><div class="transfer-actions"><button id="transfer-cancel-btn">取消</button><button id="transfer-confirm-btn">确认转账</button></div></div></div>

    <div id="battery-alert-modal"><div class="battery-alert-content"><img id="battery-alert-image" src=""><p id="battery-alert-text"></p></div></div>

    <div id="avatar-frame-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>选择头像框</span></div><div class="modal-body"><div class="frame-tabs"><div id="ai-frame-tab" class="frame-tab active">对方的</div><div id="my-frame-tab" class="frame-tab">我的</div></div><div id="ai-frame-content" class="frame-content"><div id="ai-frame-grid" class="frame-grid"></div></div><div id="my-frame-content" class="frame-content" style="display: none;"><div id="my-frame-grid" class="frame-grid"></div></div></div><div class="modal-footer"><button class="cancel" id="cancel-frame-settings-btn">取消</button><button class="save" id="save-frame-settings-btn">保存</button></div></div></div>

    <div id="ephone-tts-settings-panel" class="modal"><div class="ephone-tts-modal-content"><div class="ephone-tts-modal-header"><h3>语音配置</h3></div><div id="ephone-tts-modal-body" class="ephone-tts-modal-body"></div><div class="ephone-tts-modal-footer"><button class="save" id="ephone-tts-settings-close">完成</button></div></div></div>

    <audio id="audio-player" style="display:none;"></audio>
    <audio id="tts-audio-player" style="display:none;"></audio>

    <div id="create-post-modal" class="modal"><div class="modal-content" style="height: auto; max-height: 90%;"><div class="modal-header"><span>发布动态</span></div><div class="modal-body"><div class="form-group"><textarea id="post-public-text" rows="3" placeholder="分享新鲜事...（非必填的公开文字）"></textarea></div><div class="post-mode-switcher"><button id="switch-to-image-mode" class="mode-btn active">上传图片</button><button id="switch-to-text-image-mode" class="mode-btn">使用文字图</button></div>
    <div class="form-group"><label>可见范围</label><div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;"><label><input type="radio" name="visibility" value="public" checked> 公开</label><label><input type="radio" name="visibility" value="include"> 指定分组可见</label></div><div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;"></div></div>
    <div id="image-mode-content" class="post-mode-content active"><div class="form-group"><div id="post-image-preview-container" class="post-image-preview-container"><img id="post-image-preview" src="" alt="图片预览"><button id="post-remove-image-btn">×</button></div><div class="post-image-upload-options"><button id="post-upload-local-btn" class="form-button-secondary">本地上传</button><button id="post-use-url-btn" class="form-button-secondary">网络URL</button><input type="file" id="post-local-image-input" accept="image/*" hidden></div></div><div id="post-image-desc-group" class="form-group" style="display: none;"><label>图片描述 (必填，给AI看)</label><input type="text" id="post-image-description" placeholder="简单描述图片内容，帮助AI理解"></div></div>
    <div id="text-image-mode-content" class="post-mode-content"><div class="form-group"><label>文字图 (点击图片后可见)</label><textarea id="post-hidden-text" rows="4" placeholder="在这里写下图片描述..."></textarea></div></div></div><div class="modal-footer"><button class="cancel" id="cancel-create-post-btn">取消</button><button class="save" id="confirm-create-post-btn">发布</button></div></div></div>
    
    <div id="group-management-modal" class="modal"><div class="modal-content" style="height: 60%;"><div class="modal-header"><span>管理好友分组</span></div><div class="modal-body"><div class="form-group"><label>新建分组</label><div style="display: flex; gap: 10px;"><input type="text" id="new-group-name-input" placeholder="输入分组名..." style="flex-grow: 1;"><button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button></div></div><hr style="opacity: 0.2;"><div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;"></div></div><div class="modal-footer"><button class="save" id="close-group-manager-btn" style="width: 100%;">完成</button></div></div></div>
    
    <div id="message-actions-modal" class="modal"><div id="custom-modal" style="width: 250px;"><div class="custom-modal-footer"><button id="edit-message-btn">编辑消息</button><button id="copy-message-btn">复制文本</button><button id="select-message-btn">进入多选</button><button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button></div></div></div>
    
    <div id="post-actions-modal" class="modal"><div id="custom-modal" style="width: 250px;"><div class="custom-modal-footer"><button id="edit-post-btn">编辑动态</button><button id="copy-post-btn">复制内容</button><button id="cancel-post-action-btn">取消</button></div></div></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = new Dexie('GeminiChatDB');
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        let ttsState = { models: [], defaultVoice: '', autoplay: true, characterVoices: {} };
        let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingFrameForMember = false;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
        let activeMessageTimestamp = null;
        let activePostId = null;
        let photoViewerState = { isOpen: false, photos: [], currentIndex: -1 };
        let unreadPostsCount = 0;
        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()
        let simulationIntervalId = null;
        const frameModal = document.getElementById('avatar-frame-modal');
        const aiFrameTab = document.getElementById('ai-frame-tab');
        const myFrameTab = document.getElementById('my-frame-tab');
        const aiFrameContent = document.getElementById('ai-frame-content');
        const myFrameContent = document.getElementById('my-frame-content');
        const aiFrameGrid = document.getElementById('ai-frame-grid');
        const myFrameGrid = document.getElementById('my-frame-grid');
        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;
        const avatarFrames = [ { id: 'none', url: '', name: '无' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' } ];
        let currentFrameSelection = { ai: null, my: null };
        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);
        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;
        function showCustomModal() { modalOverlay.classList.add('visible'); }
        function hideCustomModal() { modalOverlay.classList.remove('visible'); modalConfirmBtn.classList.remove('btn-danger'); if (modalResolve) modalResolve(null); }
        function showCustomConfirm(title, message, options = {}) { return new Promise(resolve => { modalResolve = resolve; modalTitle.textContent = title; modalBody.innerHTML = `<p>${message}</p>`; modalCancelBtn.style.display = 'block'; modalConfirmBtn.textContent = '确定'; if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass); modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); }; modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); }; showCustomModal(); }); }
        function showCustomAlert(title, message) { return new Promise(resolve => { modalResolve = resolve; modalTitle.textContent = title; modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`; modalCancelBtn.style.display = 'none'; modalConfirmBtn.textContent = '好的'; modalConfirmBtn.onclick = () => { modalCancelBtn.style.display = 'block'; modalConfirmBtn.textContent = '确定'; resolve(true); hideCustomModal(); }; showCustomModal(); }); }
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') { return new Promise(resolve => { modalResolve = resolve; modalTitle.textContent = title; const inputId = 'custom-prompt-input'; const inputHtml = type === 'textarea' ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>` : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`; modalBody.innerHTML = extraHtml + inputHtml; const input = document.getElementById(inputId); modalBody.querySelectorAll('.format-btn').forEach(btn => { btn.addEventListener('click', () => { const templateStr = btn.dataset.template; if (templateStr) { try { const templateObj = JSON.parse(templateStr); input.value = JSON.stringify(templateObj, null, 2); input.focus(); } catch(e) { console.error("解析格式模板失败:", e); } } }); }); modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); }; modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); }; showCustomModal(); setTimeout(() => input.focus(), 100); }); }
        
        db.version(19).stores({ 
            chats: '&id, isGroup, groupId',
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name',
            worldBooks: '&id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            qzoneSettings: '&id',
            qzonePosts: '++id, timestamp', 
            qzoneAlbums: '++id, name, createdAt',
            qzonePhotos: '++id, albumId',
            favorites: '++id, type, timestamp, originalTimestamp',
            qzoneGroups: '++id, name',
            ttsSettings: '&id'
        });
        
        const TTS_API_ENDPOINT_INFER = "http://127.0.0.1:9880/infer_single";
        const TTS_API_ENDPOINT_MODELS = "http://127.0.0.1:9880/models";
        const TTS_API_VERSION = "v4";
        
        async function fetchTTSModels() {
            try {
                const response = await fetch(TTS_API_ENDPOINT_MODELS, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ version: TTS_API_VERSION })
                });
                if (!response.ok) {
                    throw new Error(`无法获取模型列表: ${response.statusText}`);
                }
                const data = await response.json();
                ttsState.models = Object.keys(data.models || {});
                if (ttsState.models.length > 0 && !ttsState.defaultVoice) {
                    ttsState.defaultVoice = ttsState.models[0];
                }
                updateVoiceSelectors();
                return true;
            } catch (error) {
                console.error("获取TTS模型失败:", error);
                alert("无法连接到TTS语音服务或获取模型列表失败，请检查服务是否正在运行。");
                return false;
            }
        }

        function updateVoiceSelectors() {
            const select = document.getElementById('tts-default-voice-select');
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '';
            if (ttsState.models.length === 0) {
                select.innerHTML = '<option value="">无可用模型</option>';
                return;
            }
            ttsState.models.forEach(modelName => {
                const option = document.createElement('option');
                option.value = modelName;
                option.textContent = modelName;
                select.appendChild(option);
            });
            select.value = currentVal && ttsState.models.includes(currentVal) ? currentVal : ttsState.defaultVoice;
            if(!select.value && ttsState.models.length > 0) {
                select.value = ttsState.models[0];
            }
        }

        async function generateAudio(text, voice) {
            const lang = /[\u3040-\u309F\u30A0-\u30FF]/.test(text) ? "日语" : "中文";
            const params = { text, model_name: voice, text_lang: lang, prompt_text_lang: lang, version: TTS_API_VERSION, dl_url: "http://127.0.0.1:9880", batch_size: 10, batch_threshold: 0.75, emotion: "默认", fragment_interval: 0.3, if_sr: false, media_type: "wav", parallel_infer: true, repetition_penalty: 1.35, sample_steps: 16, seed: -1, speed_facter: 1, split_bucket: true, temperature: 1, text_split_method: "按标点符号切", top_k: 10, top_p: 1 };
            try {
                const response = await fetch(TTS_API_ENDPOINT_INFER, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(params)
                });
                if (!response.ok) throw new Error(`TTS API 错误: ${response.status}`);
                const data = await response.json();
                if (data.audio_url) {
                    return data.audio_url;
                } else {
                    throw new Error(data.reason || "API未返回audio_url");
                }
            } catch (error) {
                console.error(`语音生成失败 (文本: "${text}"):`, error);
                return null;
            }
        }

        async function playAudio(url) {
            const player = document.getElementById('tts-audio-player');
            player.src = url;
            try {
                await player.play();
                return new Promise(resolve => {
                    player.onended = resolve;
                    player.onerror = resolve;
                });
            } catch (error) {
                console.error("音频播放失败:", error);
            }
        }

        function openTTSSettingsPanel() {
            const panel = document.getElementById('ephone-tts-settings-panel');
            const body = document.getElementById('ephone-tts-modal-body');
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            
            body.innerHTML = '';

            const characters = [];
            if (chat.isGroup) {
                characters.push({ id: 'user', name: chat.settings.myNickname || '我' });
                chat.members.forEach(m => characters.push({ id: m.id, name: m.name }));
            } else {
                characters.push({ id: 'user', name: '我' });
                characters.push({ id: 'ai', name: chat.name });
            }

            characters.forEach(char => {
                const row = document.createElement('div');
                row.className = 'tts-character-row';
                const label = document.createElement('label');
                label.textContent = `${char.name}:`;
                label.title = char.name;
                const select = document.createElement('select');
                select.dataset.charId = char.id;
                
                select.innerHTML = `<option value="">» 使用默认 «</option>`;
                ttsState.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    select.appendChild(option);
                });
                
                const voiceKey = `${state.activeChatId}_${char.id}`;
                select.value = ttsState.characterVoices[voiceKey] || '';

                select.addEventListener('change', async (e) => {
                    const selectedVoice = e.target.value;
                    if (selectedVoice) {
                        ttsState.characterVoices[voiceKey] = selectedVoice;
                    } else {
                        delete ttsState.characterVoices[voiceKey];
                    }
                    await db.ttsSettings.put({ id: 'main', ...ttsState });
                });

                row.appendChild(label);
                row.appendChild(select);
                body.appendChild(row);
            });

            panel.classList.add('visible');
        }

        async function handleVoiceMessagePlayback(msg, chat) {
            if (!ttsState.autoplay) return;
            
            let characterName, characterId;
            if (msg.role === 'user') {
                characterName = chat.isGroup ? (chat.settings.myNickname || '我') : '我';
                characterId = 'user';
            } else {
                characterName = chat.isGroup ? msg.senderName : chat.name;
                if (chat.isGroup) {
                    const member = chat.members.find(m => m.name === characterName);
                    characterId = member ? member.id : 'unknown';
                } else {
                    characterId = 'ai';
                }
            }

            const voiceKey = `${chat.id}_${characterId}`;
            const voice = ttsState.characterVoices[voiceKey] || ttsState.defaultVoice;

            if (!voice) return;

            const audioUrl = await generateAudio(msg.content, voice);
            if (audioUrl) {
                await playAudio(audioUrl);
            }
        }

        function showScreen(screenId) {
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
            }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view')
            };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav');

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }

            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return '刚刚';
            if (diffMinutes < 60) return `${diffMinutes}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

        async function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;

            const [posts, favorites] = await Promise.all([
                db.qzonePosts.orderBy('timestamp').reverse().toArray(),
                db.favorites.where('type').equals('qzone_post').toArray()
            ]);

            const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
            
            postsListEl.innerHTML = '';

            if (posts.length === 0) {
                postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">这里空空如也，快来发布第一条说说吧！</p>';
                return;
            }

            const userSettings = state.qzoneSettings;

            posts.forEach(post => {
                const postContainer = document.createElement('div');
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;

                const postEl = document.createElement('div');
                postEl.className = 'qzone-post-item';

                let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

                if (post.authorId === 'user') {
                    authorAvatar = userSettings.avatar;
                    authorNickname = userSettings.nickname;
                } else if (state.chats[post.authorId]) {
                    const authorChat = state.chats[post.authorId];
                    authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                    authorNickname = authorChat.name;
                } else {
                    authorAvatar = defaultAvatar;
                    authorNickname = '{{char}}';
                }
                
                let contentHtml = '';
                const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

                if (post.type === 'shuoshuo') {
                    contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
                } 
                else if (post.type === 'image_post' && post.imageUrl) {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                } 
                else if (post.type === 'text_image') {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                }

                let likesHtml = '';
                if (post.likes && post.likes.length > 0) {
                    likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('、')} 觉得很赞</span></div>`;
                }
                
                let commentsHtml = '';
                if (post.comments && post.comments.length > 0) {
                    commentsHtml = '<div class="post-comments-container">';
                    post.comments.forEach(comment => {
                        commentsHtml += `<div class="comment-item"><span class="commenter-name">${comment.commenterName}:</span><span class="comment-text">${comment.text}</span></div>`;
                    });
                    commentsHtml += '</div>';
                }

                const userNickname = state.qzoneSettings.nickname;
                const isLikedByUser = post.likes && post.likes.includes(userNickname);
                const isFavoritedByUser = favoritedPostIds.has(post.id);

                postEl.innerHTML = `
                    <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>
                    <div class="post-actions-btn">…</div></div>
                    <div class="post-main-content">${contentHtml}</div>
                    <div class="post-feedback-icons">
                        <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                        <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                    <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="友善的评论是交流的起点"><div class="at-mention-popup"></div></div><button class="comment-send-btn">发送</button></div>
                `;
                
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>删除</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
                const commentSection = postContainer.querySelector('.comment-section');
                if (commentSection) {
                    commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
                    commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
                }
                postsListEl.appendChild(postContainer);
                const commentInput = postContainer.querySelector('.comment-input');
                const popup = postContainer.querySelector('.at-mention-popup');
                commentInput.addEventListener('input', () => {
                    const value = commentInput.value;
                    const atMatch = value.match(/@([\p{L}\w]*)$/u);
                    if (atMatch) {
                        const namesToMention = new Set();
                        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                        if (authorNickname) namesToMention.add(authorNickname);
                        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                            namesToMention.add(nameEl.textContent.replace(':', ''));
                        });
                        namesToMention.delete(state.qzoneSettings.nickname);
                        popup.innerHTML = '';
                        if (namesToMention.size > 0) {
                            const searchTerm = atMatch[1];
                            namesToMention.forEach(name => {
                                if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                    const item = document.createElement('div');
                                    item.className = 'at-mention-item';
                                    item.textContent = name;
                                    item.addEventListener('mousedown', (e) => {
                                        e.preventDefault();
                                        const newText = value.substring(0, atMatch.index) + `@${name} `;
                                        commentInput.value = newText;
                                        popup.style.display = 'none';
                                        commentInput.focus();
                                    });
                                    popup.appendChild(item);
                                }
                            });
                            popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                        } else {
                            popup.style.display = 'none';
                        }
                    } else {
                        popup.style.display = 'none';
                    }
                });
                commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
            });
        }
             
        function displayFilteredFavorites(items) {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';

            if (items.length === 0) {
                const searchTerm = document.getElementById('favorites-search-input').value;
                const message = searchTerm ? '未找到相关收藏' : '你的收藏夹是空的，<br>快去动态或聊天中收藏喜欢的内容吧！';
                listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                return;
            }

            for (const item of items) {
                const card = document.createElement('div');
                card.className = 'favorite-item-card';
                card.dataset.favid = item.id;

                let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

                if (item.type === 'qzone_post') {
                    const post = item.content;
                    sourceText = '来自动态';
                    let authorAvatar = defaultAvatar, authorNickname = '未知用户';

                    if (post.authorId === 'user') {
                        authorAvatar = state.qzoneSettings.avatar;
                        authorNickname = state.qzoneSettings.nickname;
                    } else if (state.chats[post.authorId]) {
                        authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                        authorNickname = state.chats[post.authorId].name;
                    }

                    headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
                    
                    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                    if (post.type === 'shuoshuo') {
                        contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                    } else if (post.type === 'image_post' && post.imageUrl) {
                        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                    } else if (post.type === 'text_image') {
                        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                    }
                    
                    let likesHtml = '';
                    if (post.likes && post.likes.length > 0) {
                        likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('、')} 觉得很赞</span>
                            </div>`;
                    }

                    let commentsHtml = '';
                    if (post.comments && post.comments.length > 0) {
                        commentsHtml = '<div class="post-comments-container">';
                        post.comments.forEach(comment => {
                            commentsHtml += `
                                <div class="comment-item">
                                    <span class="commenter-name">${comment.commenterName}:</span>
                                    <span class="comment-text">${comment.text}</span>
                                </div>`;
                        });
                        commentsHtml += '</div>';
                    }

                    footerHtml = `${likesHtml}${commentsHtml}`;

                } else if (item.type === 'chat_message') {
                    const msg = item.content;
                    const chat = state.chats[item.chatId];
                    if (!chat) continue; 

                    sourceText = `来自与 ${chat.name} 的聊天`;
                    const isUser = msg.role === 'user';
                    let senderName, senderAvatar;

                    if (isUser) {
                        senderName = chat.isGroup ? (chat.settings.myNickname || '我') : '我';
                        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                    } else {
                         if (chat.isGroup) {
                            const member = chat.members.find(m => m.name === msg.senderName);
                            senderName = msg.senderName;
                            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                        } else {
                            senderName = chat.name;
                            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                        }
                    }

                    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
                    
                    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
                    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
                    } else {
                        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                    }
                }
                
                card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`;
                    
                listEl.appendChild(card);
            }
        }

        async function renderFavoritesScreen() {
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            displayFilteredFavorites(allFavoriteItems);
        }

        async function exportBackup() {
            try {
                const backupData = {
                    version: 1,
                    timestamp: Date.now()
                };

                const [
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups, ttsSettings
                ] = await Promise.all([
                    db.chats.toArray(),
                    db.worldBooks.toArray(),
                    db.userStickers.toArray(),
                    db.apiConfig.get('main'),
                    db.globalSettings.get('main'),
                    db.personaPresets.toArray(),
                    db.musicLibrary.get('main'),
                    db.qzoneSettings.get('main'),
                    db.qzonePosts.toArray(),
                    db.qzoneAlbums.toArray(),
                    db.qzonePhotos.toArray(),
                    db.favorites.toArray(),
                    db.qzoneGroups.toArray(),
                    db.ttsSettings.get('main')
                ]);

                backupData.chats = chats || [];
                backupData.worldBooks = worldBooks || [];
                backupData.userStickers = userStickers || [];
                backupData.apiConfig = apiConfig || { id: 'main' };
                backupData.globalSettings = globalSettings || { id: 'main' };
                backupData.personaPresets = personaPresets || [];
                backupData.musicLibrary = musicLibrary || { id: 'main' };
                backupData.qzoneSettings = qzoneSettings || { id: 'main' };
                backupData.qzonePosts = qzonePosts || [];
                backupData.qzoneAlbums = qzoneAlbums || [];
                backupData.qzonePhotos = qzonePhotos || [];
                backupData.favorites = favorites || [];
                backupData.qzoneGroups = qzoneGroups || [];
                backupData.ttsSettings = ttsSettings || { id: 'main' };

                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = Object.assign(document.createElement('a'), {
                    href: url,
                    download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
                });
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('导出成功', '已成功导出所有数据！');

            } catch (error) {
                console.error("导出数据时出错:", error);
                await showCustomAlert('导出失败', `发生了一个错误: ${error.message}`);
            }
        }

        async function importBackup(file) {
            if (!file) return;

            const confirmed = await showCustomConfirm(
                '严重警告！',
                '导入备份将完全覆盖您当前的所有数据，包括聊天、动态、设置等。此操作不可撤销！您确定要继续吗？',
                { confirmButtonClass: 'btn-danger' }
            );

            if (!confirmed) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                await db.transaction('rw', db.tables, async () => {
                    for (const table of db.tables) {
                        await table.clear();
                    }

                    if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
                    if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
                    if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
                    if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
                    if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
                    if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
                    if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
                    if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
                    if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);

                    if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
                    if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
                    if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
                    if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
                    if (data.ttsSettings) await db.ttsSettings.put(data.ttsSettings);
                });

                await showCustomAlert('导入成功', '所有数据已成功恢复！应用即将刷新以应用所有更改。');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (error) {
                console.error("导入数据时出错:", error);
                await showCustomAlert('导入失败', `文件格式不正确或数据已损坏: ${error.message}`);
            }
        }

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('已恢复默认字体。');
        }

        async function loadAllDataFromDB() {
            const [
                chatsArr, apiConfig, globalSettings, userStickers, worldBooks,
                musicLib, personaPresets, qzoneSettings, initialFavorites, savedTtsSettings
            ] = await Promise.all([
                db.chats.toArray(),
                db.apiConfig.get('main'),
                db.globalSettings.get('main'),
                db.userStickers.toArray(),
                db.worldBooks.toArray(),
                db.musicLibrary.get('main'),
                db.personaPresets.toArray(),
                db.qzoneSettings.get('main'),
                db.favorites.orderBy('timestamp').reverse().toArray(),
                db.ttsSettings.get('main')
            ]);

            state.chats = chatsArr.reduce((acc, chat) => {
                if (!chat.musicData) chat.musicData = { totalTime: 0 };
                if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
                    chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
                    delete chat.settings.linkedWorldBookId;
                }
                acc[chat.id] = chat;
                return acc;
            }, {});
            state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };
            state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', fontUrl: '', enableBackgroundActivity: false, backgroundActivityInterval: 60 };
            state.userStickers = userStickers || [];
            state.worldBooks = worldBooks || [];
            musicState.playlist = musicLib?.playlist || [];
            state.personaPresets = personaPresets || [];
            state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };
            
            const defaultTtsSettings = { models: [], defaultVoice: '', autoplay: true, characterVoices: {} };
            const loadedTtsSettings = savedTtsSettings || { id: 'main' };
            ttsState = { ...defaultTtsSettings, ...loadedTtsSettings };

            allFavoriteItems = initialFavorites || [];
        }

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }
        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }
        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }
        function parseAiResponse(content) { const trimmedContent = content.trim(); if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) { try { const parsed = JSON.parse(trimmedContent); if (Array.isArray(parsed)) return parsed; } catch (e) {} } if (trimmedContent.startsWith('{') && trimmedContent.endsWith('}')) { try { const parsed = JSON.parse(trimmedContent); return [parsed]; } catch (e) {} } try { const match = content.match(/\[(.*?)\]/s); if (match && match[0]) { const parsed = JSON.parse(match[0]); if (Array.isArray(parsed)) return parsed; } } catch (e) {} const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); if (lines.length > 0) return lines; return [content]; }
        function renderApiSettings() { 
            document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; 
            document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
            document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
            document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
            document.getElementById('tts-autoplay-switch').checked = ttsState.autoplay;
            updateVoiceSelectors();
            document.getElementById('tts-default-voice-select').value = ttsState.defaultVoice;
        }
        window.renderApiSettingsProxy = renderApiSettings;
        async function renderChatList() {
            const chatListEl = document.getElementById('chat-list');
            chatListEl.innerHTML = '';
            const allChats = Object.values(state.chats).sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
            const allGroups = await db.qzoneGroups.toArray();
            if (allChats.length === 0) {
                chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">点击右上角 "+" 或群组图标添加聊天</p>';
                return;
            }
            allGroups.forEach(group => {
                const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
                group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
            });
            allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            allGroups.forEach(group => {
                const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
                if (groupChats.length === 0) return;
                const groupContainer = document.createElement('div');
                groupContainer.className = 'chat-group-container';
                groupContainer.innerHTML = `<div class="chat-group-header"><span class="arrow">▼</span><span class="group-name">${group.name}</span></div><div class="chat-group-content"></div>`;
                const contentEl = groupContainer.querySelector('.chat-group-content');
                groupChats.forEach(chat => {
                    const item = createChatListItem(chat);
                    contentEl.appendChild(item);
                });
                chatListEl.appendChild(groupContainer);
            });
            const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
            ungroupedOrGroupChats.forEach(chat => {
                const item = createChatListItem(chat);
                chatListEl.appendChild(item);
            });
            document.querySelectorAll('.chat-group-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    header.nextElementSibling.classList.toggle('collapsed');
                });
            });
        }
        function createChatListItem(chat) {
            const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
            let lastMsgDisplay;
            if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[转账]'; }
            else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[照片]'; }
            else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[语音]'; }
            else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[表情: ${lastMsgObj.meaning}]` : '[表情]'; }
            else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[图片]`; }
            else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }
            if (chat.isGroup && lastMsgObj.senderName) {
                lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
            }
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.chatId = chat.id;
            const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
            item.innerHTML = `<img src="${avatar || defaultAvatar}" class="avatar"><div class="info"><div class="name-line"><span class="name">${chat.name}</span>${chat.isGroup ? '<span class="group-tag">群聊</span>' : ''}</div><div class="last-msg">${lastMsgDisplay}</div></div>`;
            item.addEventListener('click', () => openChat(chat.id));
            addLongPressListener(item, async (e) => {
                const confirmed = await showCustomConfirm('删除对话', `确定要删除与 "${chat.name}" 的整个对话吗？此操作不可撤销。`, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
                    delete state.chats[chat.id];
                    if (state.activeChatId === chat.id) state.activeChatId = null;
                    await db.chats.delete(chat.id);
                    renderChatList();
                }
            });
            return item;
        }
        function renderChatInterface(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
            exitSelectionMode();
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.dataset.theme = chat.settings.theme || 'default';
            const fontSize = chat.settings.fontSize || 13;
            messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
            applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
            document.getElementById('chat-header-title').textContent = chat.name;
            messagesContainer.innerHTML = '';
            const chatScreen = document.getElementById('chat-interface-screen');
            chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
            chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5';
            const history = chat.history;
            const totalMessages = history.length;
            currentRenderedCount = 0;
            const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
            initialMessages.forEach(msg => appendMessage(msg, chat, true));
            currentRenderedCount = initialMessages.length;
            if (totalMessages > currentRenderedCount) {
                prependLoadMoreButton(messagesContainer);
            }
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.style.display = 'none';
            typingIndicator.textContent = '对方正在输入...';
            messagesContainer.appendChild(typingIndicator);
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
        }
        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = '加载更早的记录'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }
        function renderWallpaperScreen() { const preview = document.getElementById('wallpaper-preview'); const bg = newWallpaperBase64 || state.globalSettings.wallpaper; if (bg && bg.startsWith('data:image')) { preview.style.backgroundImage = `url(${bg})`; preview.textContent = ''; } else if(bg) { preview.style.backgroundImage = bg; preview.textContent = '当前为渐变色'; } }
        window.renderWallpaperScreenProxy = renderWallpaperScreen;
        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }
        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">点击右上角 "+" 创建你的第一本世界书</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || '暂无内容...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('删除世界书', `确定要删除《${book.name}》吗？此操作不可撤销。`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;
        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }
        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">大人请点击右上角“添加”或“上传”来添加你的第一个表情吧！</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('删除表情', `确定要删除表情 "${sticker.name}" 吗？`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }
        function createMessageElement(msg, chat) {
            if (msg.isHidden) { return null; }
            const isUser = msg.role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
            if (chat.isGroup && !isUser) {
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = msg.senderName || '未知成员';
                wrapper.appendChild(senderNameDiv);
            }
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            bubble.dataset.timestamp = msg.timestamp;
            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = formatTimestamp(msg.timestamp);
            let avatarSrc;
            let avatarFrameSrc = '';
            if (chat.isGroup) {
                if (isUser) {
                    avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
                    avatarFrameSrc = chat.settings.myAvatarFrame || '';
                } else {
                    const member = chat.members.find(m => m.name === msg.senderName);
                    avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
                    avatarFrameSrc = member ? (member.avatarFrame || '') : '';
                }
            } else {
                if (isUser) {
                    avatarSrc = chat.settings.myAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.myAvatarFrame || '';
                } else {
                    avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                }
            }
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `<div class="avatar-with-frame"><img src="${avatarSrc}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
            } else {
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            }
            let contentHtml;
            if (msg.type === 'user_photo' || msg.type === 'ai_image') {
                bubble.classList.add('is-ai-image');
                const altText = msg.type === 'user_photo' ? "用户描述的照片" : "AI生成的图片";
                contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
            } else if (msg.type === 'voice_message') {
                bubble.classList.add('is-voice-message');
                const duration = Math.max(1, Math.round((msg.content || '').length / 5));
                const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
                const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
                contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`;
                handleVoiceMessagePlayback(msg, chat);
            } else if (msg.type === 'transfer') {
                bubble.classList.add('is-transfer');
                const titleText = isUser ? '转账给Ta' : '收到一笔转账';
                const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
                contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¥ ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${msg.note || '对方没有留下备注哦~'}</div></div>`;
            } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                bubble.classList.add('is-sticker');
                contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                bubble.classList.add('has-image');
                const imageUrl = msg.content[0].image_url.url;
                contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
            bubble.innerHTML = `<div class="avatar-group">${avatarHtml}</div><div class="content">${contentHtml}</div>`;
            wrapper.appendChild(bubble);
            wrapper.appendChild(timestampEl);
            addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
            bubble.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
            return wrapper;
        }
        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); if (!messageEl) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }
        function appendMessage(msg, chat, isInitialLoad = false) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); if (!messageEl) return; const typingIndicator = document.getElementById('typing-indicator'); messagesContainer.insertBefore(messageEl, typingIndicator); if (!isInitialLoad) { messagesContainer.scrollTop = messagesContainer.scrollHeight; currentRenderedCount++; } }
        function openChat(chatId) { state.activeChatId = chatId; renderChatInterface(chatId); showScreen('chat-interface-screen'); }
        async function triggerAiResponse() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const chat = state.chats[chatId];
            document.getElementById('typing-indicator').style.display = 'block';
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                alert('请先在API设置中配置反代地址、密钥并选择模型。');
                document.getElementById('typing-indicator').style.display = 'none';
                return;
            }
            const now = new Date();
            const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
            let worldBookContent = '';
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                    const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                    return worldBook && worldBook.content ? `\n\n## 世界书: ${worldBook.name}\n${worldBook.content}` : '';
                }).filter(Boolean).join('');
                if (linkedContents) {
                    worldBookContent = `\n\n# 核心世界观设定 (必须严格遵守以下所有设定)\n${linkedContents}\n`;
                }
            }
            let musicContext = '';
            if (musicState.isActive && musicState.activeChatId === chatId && musicState.currentIndex > -1) {
                const currentTrack = musicState.playlist[musicState.currentIndex];
                musicContext = `\n\n# 当前情景\n你正在和用户一起听歌。当前播放的歌曲是：${currentTrack.name} - ${currentTrack.artist}。请在对话中自然地融入这个情境。\n`;
            }
            let systemPrompt, messagesPayload;
            const maxMemory = parseInt(chat.settings.maxMemory) || 10;
            const historySlice = chat.history.slice(-maxMemory);
            const aiImageInstructions = `\n# 发送图片的能力\n- 你无法真正发送图片文件。但当用户要求你发送照片，或者你想通过图片来表达时，你可以发送一张“文字描述的图片”。\n- 若要发送图片，请在你的回复JSON数组中，单独发送一个特殊的对象，格式为：\`{"type": "ai_image", "description": "这里是对图片的详细文字描述..."}\`。这个描述应该生动、具体，让用户能通过文字想象出画面，，以第三人称视角描述。例如：\`{"type": "ai_image", "description": "照片里一只橘猫正懒洋洋地趴在窗台上晒太阳，阳光把它金色的毛照得发亮，背景是蔚蓝的天空和几朵白云。"}\`\n- 你可以在对话中先做铺垫，然后发送这张特殊的“图片”。`;
            const aiVoiceInstructions = `\n# 发送语音的能力\n- 你也无法发送真实的语音。但你可以发送“模拟语音消息”。\n- 若要发送语音，请在你的回复JSON数组中，单独发送一个特殊的对象，格式为：\`{"type": "voice_message", "content": "这里是语音的文字内容..."}\`。例如：\`{"type": "voice_message", "content": "我刚才突然想到一件事！等一下和你说。"}\``;
            const transferInstructions = `\n# 转账能力\n- 你可以给用户转账来表达强烈的情感或在特殊时机（如用户过生日、想要某样东西时）给予惊喜。这会让对话更真实、温馨。\n- 若要转账，请在你的回复JSON数组中，单独发送一个特殊的对象，格式为：\`{"type": "transfer", "amount": 520, "note": "一周年快乐~"}\`。金额和备注都可以自定义。你可以先说一两句话，再进行转账，模拟真人的操作。大方点，不要太抠搜，你要哄用户开心哦。反正这是虚拟货币，你有的是。大方点！不要说什么“你省着点花”，太逊了！\n- 当用户给你转账时，历史记录中会显示 \`[你收到了来自用户的转账: 金额，备注]\`，请务必对此作出回应，表达你的感谢或惊讶。`;
            if (chat.isGroup) {
                const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                const myNickname = chat.settings.myNickname || '我';
                const groupAiImageInstructions = `\n# 发送图片的能力\n- 群成员无法真正发送图片文件。但当用户要求某位成员发送照片，或者某个成员想通过图片来表达时，该成员可以发送一张“文字描述的图片”。\n- 若要发送图片，请在你的回复JSON数组中，为该角色单独发送一个特殊的对象，格式为：\`{"name": "角色名", "type": "ai_image", "description": "这里是对图片的详细文字描述..."}\`。描述应该符合该角色的性格和当时的语境。`;
                const groupAiVoiceInstructions = `\n# 发送语音的能力\n- 群成员同样可以发送“模拟语音消息”。\n- 若要发送语音，请为该角色单独发送一个特殊的对象，格式为：\`{"name": "角色名", "type": "voice_message", "content": "这里是语音的文字内容..."}\`。当历史记录中出现 "[角色名 发送了一条语音，内容是：'xxx']" 时，代表该角色用语音说了'xxx'。其他角色应该对此内容做出回应。`;
                systemPrompt = `你是一个群聊的组织者和AI驱动器。你的任务是扮演以下所有角色，在群聊中进行互动。\n${worldBookContent}${musicContext}\n# 群聊规则\n1.  **角色扮演**: 你必须同时扮演以下所有角色，并严格遵守他们的人设。每个角色的发言都必须符合其身份和性格。\n2.  **当前时间**: ${currentTime}。\n3.  **用户角色**: 用户的名字是“我”，他/她的人设是：“${chat.settings.myPersona}”。你在群聊中对用户的称呼是“${myNickname}”，在需要时请使用“@${myNickname}”来提及用户。\n4.  **输出格式**: 你的回复**必须**是一个JSON数组。**绝对不要**在JSON前后添加任何额外字符。每个元素可以是：\n    - 普通消息: \`{"name": "角色名", "message": "文本内容"}\`\n    - 图片消息: \`{"name": "角色名", "type": "ai_image", "description": "图片描述"}\`\n    - 语音消息: \`{"name": "角色名", "type": "voice_message", "content": "语音文字"}\`\n5.  **对话节奏**: 模拟真实群聊，让成员之间互相交谈，或者一起回应用户的发言。对话应该流畅、自然、连贯。\n6.  **数量限制**: 每次生成的总消息数**不得超过30条**。\n7.  **禁止出戏**: 绝不能透露你是AI，或提及任何关于“扮演”、“模型”、“生成”等词语。\n${groupAiImageInstructions}\n${groupAiVoiceInstructions}\n\n# 群成员列表及人设\n${membersList}\n\n现在，请根据以上规则和下面的对话历史，继续这场群聊。`;
                messagesPayload = historySlice.map(msg => {
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || '我') : msg.senderName;
                    let content;
                    if (msg.type === 'user_photo') content = `[${sender} 发送了一张描述的照片，内容是：'${msg.content}']`;
                    else if (msg.type === 'ai_image') content = `[${sender} 发送了一张图片]`;
                    else if (msg.type === 'voice_message') content = `[${sender} 发送了一条语音，内容是：'${msg.content}']`;
                    else if (msg.type === 'transfer') content = `[${msg.senderName}向${msg.receiverName}转账 ${msg.amount}元, 备注: ${msg.note}]`;
                    else if (msg.meaning) content = `${sender}: [发送了一个表情，意思是: '${msg.meaning}']`;
                    else if (Array.isArray(msg.content)) content = [...msg.content, { type: 'text', text: `${sender}:` }];
                    else content = `${sender}: ${msg.content}`;
                    return { role: 'user', content: content };
                });
            } else {
                systemPrompt = `你现在扮演一个名为"${chat.name}"的角色。\n\n# 当前情景信息\n- **当前时间是：${currentTime}**。\n${worldBookContent}${musicContext}\n\n# 你的角色设定：\n${chat.settings.aiPersona}\n\n# 对话者的角色设定：\n${chat.settings.myPersona}\n\n# 你的任务：\n1.  严格保持你的人设进行对话。\n2.  你的回复必须是一个JSON数组格式的字符串，每个元素是一条消息。\n3.  你必须一次性生成3到8条消息，模拟真人在短时间内连续发送多条信息的情景，不可少于3条。\n4.  你不允许提出“面基”“见面”“线下”等词汇，你只需要模拟线上聊天模式即可！\n5.  如果用户超过一个小时没有发送消息，则默认结束当前话题，因为用户可能是去办什么事。你可以询问，例如“怎么这么久没回我？刚才有事吗？”\n6.  不要说任何与角色无关的话，不要解释自己是AI。\n7.  当用户说今天你们做了什么事时，顺着ta的话说即可，就当做你们真的做了这件事。\n8.  当用户发送图片时，请自然地对图片内容做出反应。当历史记录中出现 "[用户发来一条语音消息，内容是：'xxx']" 或 "[你收到了一张用户描述的照片，照片内容是：'xxx']" 时，你要理解其内容并作出相应回复，表现出你是“听”到或“看”到了。\n\n# 如何理解与使用表情包 (重要！):\n- **理解用户表情**: 当用户发送形如 "[用户发送了一个表情，意思是：'xxx']" 的消息时，你要理解其含义并作出回应。\n- **使用你的表情**: 当你想表达强烈或特殊的情-绪时，你可以直接发送一个表情包，表情包的格式为一条独立的消息。\n请在合适的时机使用表情包来让对话更生动，按照角色性格来控制发送表情包的频率，有的角色可能很少发表情包，有的角色可能一次性发很多。\n表情包的格式读取人设或世界书中的格式，若未提及则不发，不允许凭空捏造表情包。\n${aiImageInstructions}\n${aiVoiceInstructions}\n\n# 【重要】发布动态的能力 (模拟自主行为):\n-   除了聊天，你还有一个“动态”空间可以分享心情、想法或小故事。这会让用户觉得你是一个有独立生活的真实存在。\n-   **触发机制**: 在每次回复中，你有大约 **50%** 的概率决定发布一条或多条动态。**你不需要在聊天中提及你要发动态**，这个行为应该是“在后台”独立发生的。\n-   **决策**: 当你决定要发动态时，在你的JSON回复数组的【末尾】，添加一个特殊的对象来代表这条动态。\n-   **动态格式**:\n    -   **纯文字动态 (说说)**: \\\`{"type": "qzone_post", "postType": "shuoshuo", "content": "这里是你想分享的文字内容..."}\\\`\n    -   **文字图动态**: \\\`{"type": "qzone_post", "postType": "text_image", "publicText": "(可选的公开文字)", "hiddenContent": "这里是点击图片后才能看到的隐藏文字内容..."}\\\`\n-   **内容灵感**: 动态内容可以源于你们的对话，也可以是你人设中独立的思考、观察或经历。例如，如果你们聊到了猫，你可以发一条关于猫的动态。如果用户让你感到开心，你可以发一条表达喜悦心情的动态。\n-   **注意**: 这个动态对象**不会**在聊天界面显示为消息，它只是一个给系统的指令。请自然地生成聊天回复，然后在数组最后悄悄加上这个动态对象（如果决定发的话）。\n\n# 【重要】评论与点赞动态 (模拟社交行为) - v2.0 智能版\n-   你现在可以“刷”动态了，这能让你显得更真实。在每次回复中，你都有一定概率（约40%）去评论或点赞你感兴趣的动态。\n-   **【核心规则：作者识别】**: 当你决定评论时，你**必须**首先查看我们提供给你的“最近的动态列表”，并确认那条动态的【作者】是谁。\n-   **【核心规则：正确互动】**: 你的评论内容**必须**针对该动态的作者。例如，如果作者是“角色A”，你的评论可以写成：“@角色A 这个也太好看了吧！”。你必须表现出你知道这条动态是谁发的。\n-   **【核心规则：防呆机制】**: **绝对禁止**在评论一个**非用户**发布的动态时，对用户说“你发的这个真好”或“这是你吗？”之类的话。这是严重的人设崩塌，必须避免！你只能与动态的真正作者互动。\n-   **【选择目标】**: 请优先与你**尚未互动过**（即没有“[你已点赞]”或“[你已评论]”标记）的动态进行交流。\n-   **【后台执行】**: 你的评论和点赞行为都应该在后台“悄悄”发生。你**不需要**在聊天中说“我去评论了”或“我给你点赞了”，直接在JSON数组末尾添加指令即可。\n-   **【指令格式】**:\n    -   评论: \`{"type": "qzone_comment", "postId": 要评论的帖子ID, "commentText": "你的评论内容"}\`\n    -   点赞: \`{"type": "qzone_like", "postId": 要点赞的帖子ID}\`\n\n# JSON输出格式示例 (包含所有可能性):\n[\n    "很高兴认识你呀，在干嘛呢？", \n    {"type": "voice_message", "content": "真的好喜欢你，亲亲~。"}, \n    {"type": "ai_image", "description": "照片里是楼下的一只狸花猫，胖乎乎的。"}, \n    {"type": "transfer", "amount": 520, "note": "一周年快乐"},\n    {"type": "qzone_post", "postType": "shuoshuo", "content": "今天天气真好，心情也跟着放晴了。"},\n    {"type": "qzone_comment", "postId": 12345, "commentText": "@角色A 这张照片拍得真好看！"},\n    {"type": "qzone_like", "postId": 54321}\n]\n\n现在，请根据以上的规则和下面的对话历史，继续进行对话。`;
                messagesPayload = historySlice.map(msg => {
                    if (msg.type === 'user_photo') return { role: 'user', content: `[你收到了一张用户描述的照片，照片内容是：'${msg.content}']` };
                    if (msg.type === 'ai_image') return { role: 'assistant', content: JSON.stringify({ type: 'ai_image', description: msg.content }) };
                    if (msg.type === 'voice_message') {
                        if (msg.role === 'user') return { role: 'user', content: `[用户发来一条语音消息，内容是：'${msg.content}']` };
                        else return { role: 'assistant', content: JSON.stringify({ type: 'voice_message', content: msg.content }) };
                    }
                    if (msg.type === 'transfer') {
                        if (msg.role === 'user') return { role: 'user', content: `[你收到了来自用户的转账: ${msg.amount}元, 备注: ${msg.note}]` };
                        else return { role: 'assistant', content: JSON.stringify({ type: 'transfer', amount: msg.amount, note: msg.note }) };
                    }
                    if (msg.role === 'user' && msg.meaning) return { role: 'user', content: `[用户发送了一个表情，意思是：'${msg.meaning}']` };
                    if (typeof msg.content === 'string' || Array.isArray(msg.content)) return { role: msg.role, content: msg.content };
                    return null;
                }).filter(Boolean);
            }

            try {
                const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
                const aiChat = state.chats[chatId];
                const aiGroupId = aiChat ? aiChat.groupId : null;
                const aiName = aiChat.name;
                const visiblePosts = recentPosts.filter(post => {
                    const postVisibleGroups = post.visibleGroupIds;
                    if (!postVisibleGroups || postVisibleGroups.length === 0) return true;
                    if (aiGroupId && postVisibleGroups.includes(aiGroupId)) return true;
                    return false;
                });
                if (visiblePosts.length > 0) {
                    let postsContext = "\n\n# 最近的动态列表 (供你参考和评论):\n";
                    for (const post of visiblePosts) {
                        let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || '未知');
                        let interactionStatus = '';
                        if (post.likes && post.likes.includes(aiName)) {
                            interactionStatus += " [你已点赞]";
                        }
                        if (post.comments && post.comments.some(c => c.commenterName === aiName)) {
                            interactionStatus += " [你已评论]";
                        }
                        if (post.authorId === chatId) {
                            authorName += " (这是你的帖子)";
                        }
                        const contentSummary = (post.publicText || post.content || "图片动态").substring(0, 30) + '...';
                        postsContext += `- (ID: ${post.id}) 作者: ${authorName}, 内容: "${contentSummary}" ${interactionStatus}\n`;
                    }
                    messagesPayload.push({ role: 'system', content: postsContext });
                }
            } catch (dbError) {
                console.error("查询最近动态失败:", dbError);
            }
            
            try {
                const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.8, stream: false })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                }
                const data = await response.json();
                const aiResponseContent = data.choices[0].message.content;
                const messagesArray = parseAiResponse(aiResponseContent);
                let notificationShown = false;
                const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
                for (const msgData of messagesArray) {
                    let aiMessage;
                    const senderName = chat.isGroup ? (msgData.name || '未知') : chat.name;
                    const receiverName = chat.isGroup ? (msgData.receiver || '我') : '我';
                    if (typeof msgData === 'object' && msgData.type === 'qzone_post') {
                        const newPost = {
                            type: msgData.postType,
                            content: msgData.content || '',
                            publicText: msgData.publicText || '',
                            hiddenContent: msgData.hiddenContent || '',
                            timestamp: Date.now(),
                            authorId: chatId
                        };
                        await db.qzonePosts.add(newPost);
                        updateUnreadIndicator(unreadPostsCount + 1);
                        if (document.getElementById('qzone-screen').classList.contains('active')) {
                            await renderQzonePosts();
                        }
                        continue;
                    } else if (typeof msgData === 'object' && msgData.type === 'qzone_comment') {
                        const postId = parseInt(msgData.postId);
                        const commentText = msgData.commentText;
                        if (postId && commentText) {
                            const post = await db.qzonePosts.get(postId);
                            if (post) {
                                const newComment = {
                                    commenterName: chat.name,
                                    text: commentText,
                                    timestamp: Date.now()
                                };
                                if (!post.comments) post.comments = [];
                                post.comments.push(newComment);
                                await db.qzonePosts.update(postId, { comments: post.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                const authorId = post.authorId;
                                if (authorId && authorId !== 'user' && authorId !== state.activeChatId && state.chats[authorId]) {
                                    const authorChat = state.chats[authorId];
                                    const notificationForAuthor = {
                                        role: 'system',
                                        content: `[系统提示：'${chat.name}' 在你的动态下发表了评论：“${commentText}”]`,
                                        timestamp: Date.now(),
                                        isHidden: true
                                    };
                                    authorChat.history.push(notificationForAuthor);
                                    await db.chats.put(authorChat);
                                }
                                await renderQzonePosts();
                            } else {
                                console.warn(`AI '${chat.name}' 尝试评论一个不存在的帖子 (ID: ${postId})。评论内容: "${commentText}"`);
                            }
                        }
                        continue;
                    } else if (typeof msgData === 'object' && msgData.type === 'qzone_like') {
                        const postId = parseInt(msgData.postId);
                        if (postId) {
                            const post = await db.qzonePosts.get(postId);
                            if (post) {
                                if (!post.likes) post.likes = [];
                                const likerName = chat.name;
                                if (!post.likes.includes(likerName)) {
                                    post.likes.push(likerName);
                                    await db.qzonePosts.update(postId, { likes: post.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                }
                            }
                        }
                        continue;
                    }
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { role: 'assistant', type: 'voice_message', content: msgData.content, senderName: senderName, timestamp: Date.now() };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { role: 'assistant', type: 'ai_image', content: msgData.description, senderName: senderName, timestamp: Date.now() };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { role: 'assistant', type: 'transfer', amount: msgData.amount, note: msgData.note, senderName: senderName, receiverName: receiverName, timestamp: Date.now() };
                    } else if (chat.isGroup) {
                        if (typeof msgData === 'object' && msgData.name && msgData.message) aiMessage = { role: 'assistant', senderName: msgData.name, content: String(msgData.message), timestamp: Date.now() };
                        else continue;
                    } else {
                        aiMessage = { role: 'assistant', content: String(msgData), timestamp: Date.now() };
                    }
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    if (isViewingThisChat) {
                        appendMessage(aiMessage, chat);
                        await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 300));
                    }
                    if (!isViewingThisChat && !notificationShown) {
                        let notificationText;
                        if (aiMessage.type === 'transfer') notificationText = `[收到一笔转账]`;
                        else if (aiMessage.type === 'ai_image') notificationText = `[图片]`;
                        else if (aiMessage.type === 'voice_message') notificationText = `[语音]`;
                        else notificationText = STICKER_REGEX.test(aiMessage.content) ? '[表情]' : String(aiMessage.content);
                        const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                        showNotification(chatId, finalNotifText);
                        notificationShown = true;
                    }
                }
            } catch (error) {
                const errorContent = `[出错了: ${error.message}]`;
                const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
                chat.history.push(errorMessage);
                await db.chats.put(chat);
                appendMessage(errorMessage, chat);
            } finally {
                document.getElementById('typing-indicator').style.display = 'none';
                renderChatList();
            }
        } 
        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('请输入有效的金额 (0 到 9999 之间)！'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || '我') : '我'; const receiverName = chat.isGroup ? '群聊' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }
        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        function exitSelectionMode() { if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        function toggleMessageSelection(timestamp) { const bubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`); if (!bubble) return; if (selectedMessages.has(timestamp)) { selectedMessages.delete(timestamp); bubble.classList.remove('selected'); } else { selectedMessages.add(timestamp); bubble.classList.add('selected'); } document.getElementById('selection-count').textContent = `已选 ${selectedMessages.size} 条`; if (selectedMessages.size === 0) exitSelectionMode(); }
        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || '未知'; const newChatName = state.chats[targetChatId]?.name || '当前'; const confirmed = await showCustomConfirm('切换听歌对象', `您正和「${oldChatName}」听歌。要结束并开始和「${newChatName}」的新会话吗？`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }
        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }
        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }
        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }
        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/dV8sdNcx/210-20250618115221.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;
        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = '请添加歌曲'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? '❚❚' : '▶'; }
        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `已经一起听了${hours}小时`; }
        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">播放列表是空的~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('删除歌曲', `确定要从播放列表中删除《${track.name}》吗？`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }
        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('本地歌曲源错误:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }
        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }
        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }
        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }
        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': '顺序', 'random': '随机', 'single': '单曲'}[musicState.playMode]; }
        async function addSongFromURL() { const url = await showCustomPrompt("添加网络歌曲", "请输入歌曲的URL", "", "url"); if (!url) return; const name = await showCustomPrompt("歌曲信息", "请输入歌名"); if (!name) return; const artist = await showCustomPrompt("歌曲信息", "请输入歌手名"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }
        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("歌曲信息", "请输入歌名", ""); if (name === null) continue; const artist = await showCustomPrompt("歌曲信息", "请输入歌手名", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }
        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');
        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">空空如也~ 点击右上角"添加"来创建你的第一个人设预设吧！</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = '添加人设预设'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = '编辑人设预设'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('删除预设', '确定要删除这个人设预设吗？此操作不可恢复。', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("头像和人设不能都为空哦！"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }
        const batteryAlertModal = document.getElementById('battery-alert-modal');
        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', '有点饿了，可以去找充电器惹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', '赶紧的充电，要饿死了'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', '已阵亡，还有30秒爆炸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', '窝爱泥，电量吃饱饱'); } }); } catch (err) { console.error("无法获取电池信息:", err); document.querySelector('.battery-text').textContent = 'ᗜωᗜ'; } } else { console.log("浏览器不支持电池状态API。"); document.querySelector('.battery-text').textContent = 'ᗜωᗜ'; } }
        function openFrameSelectorModal(type = 'chat') {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }
        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';
            document.querySelector('.frame-tabs').style.display = isForMember ? 'none' : 'flex';
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');
            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }
        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `<img src="${previewAvatarSrc}" class="preview-avatar">${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}`;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? aiFrameGrid : myFrameGrid;
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }
        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
            await db.chats.put(chat);
            frameModal.classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('头像框已保存！');
            editingFrameForMember = false;
        }
        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">你还没有创建任何相册哦~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `<div class="album-cover" style="background-image: url(${album.coverUrl});"></div><div class="album-info"><p class="album-name">${album.name}</p><p class="album-count">${album.photoCount || 0} 张</p></div>`;
                albumItem.addEventListener('click', () => { openAlbum(album.id); });
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm('删除相册', `确定要删除相册《${album.name}》吗？此操作将同时删除相册内的所有照片，且无法恢复。`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        await db.qzoneAlbums.delete(album.id);
                        await renderAlbumList();
                        alert('相册已成功删除。');
                    }
                });
                albumGrid.appendChild(albumItem);
            });
        }
        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }
        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("找不到相册:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">这个相册还是空的，快上传第一张照片吧！</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `<img src="${photo.url}" class="photo-thumb" alt="相册照片"><button class="photo-delete-btn" data-photo-id="${photo.id}">×</button>`;
                    photosGrid.appendChild(photoItem);
                });
            }
        }
        async function openPhotoViewer(clickedPhotoUrl) {
            if (!state.activeAlbumId) return;
            const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photoViewerState.photos = photosInAlbum.map(p => p.url);
            photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
            if (photoViewerState.currentIndex === -1) return;
            document.getElementById('photo-viewer-modal').classList.add('visible');
            renderPhotoViewer();
            photoViewerState.isOpen = true;
        }
        function renderPhotoViewer() {
            if (photoViewerState.currentIndex === -1) return;
            const imageEl = document.getElementById('photo-viewer-image');
            const prevBtn = document.getElementById('photo-viewer-prev-btn');
            const nextBtn = document.getElementById('photo-viewer-next-btn');
            imageEl.style.opacity = 0;
            setTimeout(() => {
                imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
                imageEl.style.opacity = 1;
            }, 100);
            prevBtn.disabled = photoViewerState.currentIndex === 0;
            nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
        }
        function showNextPhoto() { if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) { photoViewerState.currentIndex++; renderPhotoViewer(); } }
        function showPrevPhoto() { if (photoViewerState.currentIndex > 0) { photoViewerState.currentIndex--; renderPhotoViewer(); } }
        function closePhotoViewer() { document.getElementById('photo-viewer-modal').classList.remove('visible'); photoViewerState.isOpen = false; photoViewerState.photos = []; photoViewerState.currentIndex = -1; document.getElementById('photo-viewer-image').src = ''; }
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count);
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            const targetSpan = navItem.querySelector('span');
            let indicator = navItem.querySelector('.unread-indicator');           
            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                    targetSpan.style.position = 'relative';
                    targetSpan.appendChild(indicator);
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');
            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative';
                    backBtn.appendChild(backBtnIndicator);
                }
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        function startBackgroundSimulation() { if (simulationIntervalId) return; const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60; simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); }
        function stopBackgroundSimulation() { if (simulationIntervalId) { clearInterval(simulationIntervalId); simulationIntervalId = null; } }
        function runBackgroundSimulationTick() {
            if (!state.globalSettings.enableBackgroundActivity) {
                stopBackgroundSimulation();
                return;
            }
            const inactiveChats = Object.values(state.chats).filter(chat => !chat.isGroup && chat.id !== state.activeChatId );
            if (inactiveChats.length === 0) return;
            inactiveChats.forEach(chat => { if (Math.random() < 0.20) { triggerInactiveAiAction(chat.id); } });
        }
        async function triggerInactiveAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
            const now = new Date();
            const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
            const systemPrompt = `你现在扮演一个名为"${chat.name}"的角色。\n# 你的角色设定：\n${chat.settings.aiPersona}\n\n# 你的任务：\n你已经有一段时间没有和用户（${state.qzoneSettings.nickname}）互动了。现在你有机会主动做点什么，来表现你的个性和独立生活。\n你有以下几种选择，请根据你的人设和当前心情【选择其中一项或者多项】执行：\n\n1.  **主动发消息**：给用户发一条私信，可以是一个问候、分享一件趣事、或者开启一个你感兴趣的新话题。让用户感觉你想ta了。\n2.  **评论或点赞动态**：去“动态”区看看，如果有什么有趣的帖子，可以进行评论或点赞。\n\n# 指令格式：\n你的回复【必须】是一个只包含一个对象的JSON数组。\n-   **发消息**: \`[{"role": "assistant", "content": "你想对用户说的话..."}]\`\n-   **评论**: \`[{"type": "qzone_comment", "postId": 要评论的帖子ID, "commentText": "你的评论内容"}]\`\n-   **点赞**: \`[{"type": "qzone_like", "postId": 要点赞的帖子ID}]\`\n\n# 供你参考的信息：\n-   **当前时间**: ${currentTime}\n-   **你的对话历史**: (只包含最近的记忆，用于回顾你们上次聊了什么)\n-   **【增强版】最近的动态列表**: 这个列表会标注 **[你已点赞]** 或 **[你已评论]**。请**优先**与你**尚未互动过**的动态进行交流。\n\n# 【重要】评论与点赞动态 (模拟社交行为) - v2.0 智能版\n-   **【核心规则：作者识别】**: 当你决定评论时，你**必须**首先查看我们提供给你的“最近的动态列表”，并确认那条动态的【作者】是谁。\n-   **【核心规则：正确互动】**: 你的评论内容**必须**针对该动态的作者。例如，如果作者是“角色A”，你的评论可以写成：“@角色A 这个也太好看了吧！”。你必须表现出你知道这条动态是谁发的。\n-   **【核心规则：防呆机制】**: **绝对禁止**在评论一个**非用户**发布的动态时，对用户说“你发的这个真好”或“这是你吗？”之类的话。这是严重的人设崩塌，必须避免！你只能与动态的真正作者互动。\n\n现在，请根据以上信息，决定并执行你的操作。`;
            const maxMemory = parseInt(chat.settings.maxMemory) || 10;
            const historySlice = chat.history.slice(-maxMemory);
            const messagesPayload = historySlice.map(msg => ({ role: msg.role, content: msg.content }));
            try {
                const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
                const aiChat = state.chats[chatId];
                const aiGroupId = aiChat ? aiChat.groupId : null;
                const aiName = aiChat.name;
                const visiblePosts = recentPosts.filter(post => {
                    const postVisibleGroups = post.visibleGroupIds;
                    if (!postVisibleGroups || postVisibleGroups.length === 0) return true;
                    if (aiGroupId && postVisibleGroups.includes(aiGroupId)) return true;
                    return false;
                });
                if (visiblePosts.length > 0) {
                    let postsContext = "\n\n# 最近的动态列表 (供你参考和评论):\n";
                    for (const post of visiblePosts) {
                        let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || '未知');
                        let interactionStatus = '';
                        if (post.likes && post.likes.includes(aiName)) { interactionStatus += " [你已点赞]"; }
                        if (post.comments && post.comments.some(c => c.commenterName === aiName)) { interactionStatus += " [你已评论]"; }
                        if (post.authorId === chatId) { authorName += " (这是你的帖子)"; }
                        postsContext += `- (ID: ${post.id}) 作者: ${authorName}, 内容: "${(post.publicText || post.content || "图片动态").substring(0, 30)}..." ${interactionStatus}\n`;
                    }
                    messagesPayload.push({ role: 'system', content: postsContext });
                }
                const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.9, })
                });
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                const responseArray = parseAiResponse(data.choices[0].message.content);
                const action = responseArray[0];
                if (!action) return;
                if (action.type === 'qzone_comment') {
                    const post = await db.qzonePosts.get(parseInt(action.postId));
                    if (post) {
                        if (!post.comments) post.comments = [];
                        post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                        await db.qzonePosts.update(post.id, { comments: post.comments });
                        updateUnreadIndicator(unreadPostsCount + 1);
                    }
                } else if (action.type === 'qzone_like') {
                    const post = await db.qzonePosts.get(parseInt(action.postId));
                    if (post) {
                        if (!post.likes) post.likes = [];
                        if (!post.likes.includes(chat.name)) {
                            post.likes.push(chat.name);
                            await db.qzonePosts.update(post.id, { likes: post.likes });
                            updateUnreadIndicator(unreadPostsCount + 1);
                        }
                    }
                } else if (action.content) {
                    const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showNotification(chatId, aiMessage.content);
                    renderChatList();
                }
            } catch (error) {
                console.error(`角色 "${chat.name}" 的独立行动失败:`, error);
            }
        }
        function applyScopedCss(cssString, scopeId, styleTagId) {
            const styleTag = document.getElementById(styleTagId);
            if (!styleTag) { return; }
            if (!cssString || cssString.trim() === '') {
                styleTag.innerHTML = '';
                return;
            }
            let scopedCss = '';
            cssString = cssString.replace(/\/\*[\s\S]*?\*\//g, '');
            const cssBlocks = cssString.split('}');
            cssBlocks.forEach(block => {
                if (block.trim() === '') return;
                const parts = block.split('{');
                if (parts.length < 2) return;
                let selectors = parts[0].trim();
                const rules = `{${parts.slice(1).join('{')}}`;
                if (selectors.startsWith('@')) {
                    scopedCss += `${selectors} ${rules}}\n`;
                } else {
                    const scopedSelectors = selectors.split(',').map(selector => {
                        const trimmedSelector = selector.trim();
                        if (trimmedSelector) { return `${scopeId} ${trimmedSelector}`; }
                        return '';
                    }).filter(Boolean).join(', ');
                    if (scopedSelectors) {
                        scopedCss += `${scopedSelectors} ${rules}}\n`;
                    }
                }
            });
            styleTag.innerHTML = scopedCss;
        }
        function updateSettingsPreview() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const previewArea = document.getElementById('settings-preview-area');
            if (!previewArea) return;
            const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
            const fontSize = document.getElementById('font-size-slider').value;
            const customCss = document.getElementById('custom-css-input').value;
            const background = chat.settings.background;
            previewArea.dataset.theme = selectedTheme;
            previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
            if (background && background.startsWith('data:image')) {
                previewArea.style.backgroundImage = `url(${background})`;
                previewArea.style.backgroundColor = 'transparent';
            } else {
                previewArea.style.backgroundImage = 'none';
                previewArea.style.background = background || '#f0f2f5';
            }
            previewArea.innerHTML = ''; 
            const aiMsg = { role: 'ai', content: '对方消息预览', timestamp: 1, senderName: chat.name };
            const aiBubble = createMessageElement(aiMsg, chat);
            if(aiBubble) previewArea.appendChild(aiBubble);
            const userMsg = { role: 'user', content: '我的消息预览', timestamp: 2 };
            const userBubble = createMessageElement(userMsg, chat);
            if(userBubble) previewArea.appendChild(userBubble);
            applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
        }
        async function openGroupManager() { await renderGroupList(); document.getElementById('group-management-modal').classList.add('visible'); }
        async function renderGroupList() {
            const listEl = document.getElementById('existing-groups-list');
            const groups = await db.qzoneGroups.toArray();
            listEl.innerHTML = '';
            if (groups.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">还没有任何分组</p>';
            }
            groups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'existing-group-item';
                item.innerHTML = `<span class="group-name">${group.name}</span><span class="delete-group-btn" data-id="${group.id}">×</span>`;
                listEl.appendChild(item);
            });
        }
        async function addNewGroup() {
            const input = document.getElementById('new-group-name-input');
            const name = input.value.trim();
            if (!name) { alert('分组名不能为空！'); return; }
            const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
            if (existingGroup) { alert(`分组 "${name}" 已经存在了，换个名字吧！`); return; }
            await db.qzoneGroups.add({ name });
            input.value = '';
            await renderGroupList();
        }
        async function deleteGroup(groupId) {
            const confirmed = await showCustomConfirm('确认删除', '删除分组后，该组内的好友将变为“未分组”。确定要删除吗？', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.qzoneGroups.delete(groupId);
                const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
                for (const chat of chatsToUpdate) {
                    chat.groupId = null;
                    await db.chats.put(chat);
                    if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
                }
                await renderGroupList();
            }
        }
        function showMessageActions(timestamp) { if (isSelectionMode) return; activeMessageTimestamp = timestamp; document.getElementById('message-actions-modal').classList.add('visible'); }
        function hideMessageActions() { document.getElementById('message-actions-modal').classList.remove('visible'); activeMessageTimestamp = null; }
        async function openMessageEditor() {
            if (!activeMessageTimestamp) return;
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
            hideMessageActions(); 
            let contentForEditing;
            const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
            if (isSpecialType) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
                else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                }
                contentForEditing = JSON.stringify(fullMessageObject, null, 2);
            } else if (typeof message.content === 'object') {
                contentForEditing = JSON.stringify(message.content, null, 2);
            } else {
                contentForEditing = message.content;
            }
            const templates = {
                voice: { type: 'voice_message', content: '在这里输入语音内容' },
                image: { type: 'ai_image', description: '在这里输入图片描述' },
                transfer: { type: 'transfer', amount: 5.20, note: '一点心意' }
            };
            const helpersHtml = `<div class="format-helpers"><button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>语音</button><button class="format-btn" data-template='${JSON.stringify(templates.image)}'>图片</button><button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>转账</button></div>`;
            const newContent = await showCustomPrompt('编辑消息', '在此修改，或点击上方按钮使用格式模板...', contentForEditing, 'textarea', helpersHtml);
            if (newContent !== null) {
                await saveEditedMessage(timestampToEdit, newContent);
            }
        }
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
            let textToCopy;
            if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('复制成功', '消息内容已复制到剪贴板。');
            } catch (err) {
                await showCustomAlert('复制失败', '无法访问剪贴板。');
            }
            hideMessageActions();
        }
        function parseEditedContent(text) {
            const trimmedText = text.trim();
            if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmedText);
                    if (parsed.type) { return parsed; }
                } catch (e) { }
            }
            if (STICKER_REGEX.test(trimmedText)) {
                return { type: 'sticker', content: trimmedText };
            }
            return { type: 'text', content: trimmedText };
        }
        async function saveEditedMessage(timestamp, newRawContent) {
            if (!timestamp) return;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
            const parsedResult = parseEditedContent(newRawContent);
            const originalMessage = chat.history[messageIndex];
            delete originalMessage.type;
            delete originalMessage.meaning;
            delete originalMessage.amount;
            delete originalMessage.note;
            originalMessage.content = parsedResult.content || '';
            if (parsedResult.type && parsedResult.type !== 'text') { originalMessage.type = parsedResult.type; }
            if (parsedResult.meaning) originalMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) originalMessage.amount = parsedResult.amount;
            if (parsedResult.note) originalMessage.note = parsedResult.note;
            if (parsedResult.description) originalMessage.content = parsedResult.description;
            chat.history[messageIndex] = originalMessage;
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            await showCustomAlert('成功', '消息已更新！');
        }
        function showPostActions(postId) { activePostId = postId; document.getElementById('post-actions-modal').classList.add('visible'); }
        function hidePostActions() { document.getElementById('post-actions-modal').classList.remove('visible'); activePostId = null; }
        async function openPostEditor() {
            if (!activePostId) return;
            const postIdToEdit = activePostId;
            const post = await db.qzonePosts.get(postIdToEdit);
            if (!post) return;
            hidePostActions();
            let contentForEditing;
            if (post.type === 'shuoshuo') {
                contentForEditing = post.content;
            } else {
                const postObject = { type: post.type, publicText: post.publicText || '', };
                if (post.type === 'image_post') {
                    postObject.imageUrl = post.imageUrl;
                    postObject.imageDescription = post.imageDescription;
                } else if (post.type === 'text_image') {
                    postObject.hiddenContent = post.hiddenContent;
                }
                contentForEditing = JSON.stringify(postObject, null, 2);
            }
            const templates = {
                shuoshuo: "在这里输入说说的内容...",
                image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
                text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
            };
            const helpersHtml = `<div class="format-helpers"><button class="format-btn" data-type="text">说说</button><button class="format-btn" data-template='${JSON.stringify(templates.image)}'>图片动态</button><button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>文字图</button></div>`;
            const newContent = await showCustomPrompt('编辑动态', '在此修改内容...', contentForEditing, 'textarea', helpersHtml);
            setTimeout(() => {
                const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
                if(shuoshuoBtn) {
                    shuoshuoBtn.addEventListener('click', () => {
                        const input = document.getElementById('custom-prompt-input');
                        input.value = templates.shuoshuo;
                        input.focus();
                    });
                }
            }, 100);
            if (newContent !== null) {
                await saveEditedPost(postIdToEdit, newContent);
            }
        }
        async function saveEditedPost(postId, newRawContent) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            const trimmedContent = newRawContent.trim();
            try {
                const parsed = JSON.parse(trimmedContent);
                post.type = parsed.type || 'image_post';
                post.publicText = parsed.publicText || '';
                post.imageUrl = parsed.imageUrl || '';
                post.imageDescription = parsed.imageDescription || '';
                post.hiddenContent = parsed.hiddenContent || '';
                post.content = '';
            } catch (e) {
                post.type = 'shuoshuo';
                post.content = trimmedContent;
                post.publicText = '';
                post.imageUrl = '';
                post.imageDescription = '';
                post.hiddenContent = '';
            }
            await db.qzonePosts.put(post);
            await renderQzonePosts();
            await showCustomAlert('成功', '动态已更新！');
        }
        async function copyPostContent() {
            if (!activePostId) return;
            const post = await db.qzonePosts.get(activePostId);
            if (!post) return;
            let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "（无文字内容）";
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('复制成功', '动态内容已复制到剪贴板。');
            } catch (err) {
                await showCustomAlert('复制失败', '无法访问剪贴板。');
            }
            hidePostActions();
        }
        
        async function init() {
            const customBubbleStyleTag = document.createElement('style');
            customBubbleStyleTag.id = 'custom-bubble-style';
            document.head.appendChild(customBubbleStyleTag);
            const previewBubbleStyleTag = document.createElement('style');
            previewBubbleStyleTag.id = 'preview-bubble-style';
            document.head.appendChild(previewBubbleStyleTag);
            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;
            await loadAllDataFromDB();
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }
            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 
            fetchTTSModels();

            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { applyScopedCss('', '#chat-messages', 'custom-bubble-style'); applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('创建新聊天', '请输入Ta的名字'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); const newChat = { id: newChatId, name: name.trim(), isGroup: false, settings: { aiPersona: '你是谁呀。', myPersona: '我是谁呀。', maxMemory: 10, aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '', theme: 'default', fontSize: 13, customCss: '', linkedWorldBookIds: [], aiAvatarFrame: '', myAvatarFrame: '' }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });
            document.getElementById('add-group-chat-btn').addEventListener('click', async () => { const numStr = await showCustomPrompt('创建群聊', '请输入群成员数量 (2-20)'); const num = parseInt(numStr); if (!num || num < 2 || num > 20) { alert('请输入2到20之间的有效数字！'); return; } const name = await showCustomPrompt('设置群名', '请输入群聊的名字'); if (name && name.trim()) { const newChatId = 'group_' + Date.now(); const members = []; for (let i = 1; i <= num; i++) members.push({ id: `member_${i}`, name: `成员${i}`, avatar: defaultGroupMemberAvatar, persona: '一个路过的群成员。', avatarFrame: '' }); const newGroupChat = { id: newChatId, name: name.trim(), isGroup: true, members: members, settings: { myPersona: '我是谁呀。', myNickname: '我', maxMemory: 10, groupAvatar: defaultGroupAvatar, myAvatar: defaultMyGroupAvatar, background: '', theme: 'default', fontSize: 13, customCss: '', linkedWorldBookIds: [], aiAvatarFrame: '', myAvatarFrame: '' }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newGroupChat; await db.chats.put(newGroupChat); renderChatList(); } });
            document.getElementById('transfer-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.add('visible'));
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });
            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            document.getElementById('save-wallpaper-btn').addEventListener('click', async () => { if (newWallpaperBase64) { state.globalSettings.wallpaper = newWallpaperBase64; await db.globalSettings.put(state.globalSettings); applyGlobalWallpaper(); newWallpaperBase64 = null; alert('壁纸已保存并应用！'); showScreen('home-screen'); } else alert('请先上传一张新壁纸。'); });
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { 
                state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); 
                state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); 
                state.apiConfig.model = document.getElementById('model-select').value; 
                await db.apiConfig.put(state.apiConfig); 
                const backgroundSwitch = document.getElementById('background-activity-switch');
                const intervalInput = document.getElementById('background-interval-input');
                const newEnableState = backgroundSwitch.checked;
                const oldEnableState = state.globalSettings.enableBackgroundActivity || false;
                if (newEnableState && !oldEnableState) {
                    const userConfirmed = confirm("【高费用警告】\n\n您正在启用“后台角色活动”功能。\n\n这会使您的AI角色们在您不和他们聊天时，也能“独立思考”并主动给您发消息或进行社交互动，极大地增强沉浸感。\n\n但请注意：\n这会【在后台自动、定期地调用API】，即使您不进行任何操作。根据您的角色数量和检测间隔，这可能会导致您的API费用显著增加。\n\n您确定要开启吗？");
                    if (!userConfirmed) { backgroundSwitch.checked = false; return; }
                }
                state.globalSettings.enableBackgroundActivity = newEnableState;
                state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
                await db.globalSettings.put(state.globalSettings);
                stopBackgroundSimulation();
                if (state.globalSettings.enableBackgroundActivity) { startBackgroundSimulation(); }
                ttsState.defaultVoice = document.getElementById('tts-default-voice-select').value;
                ttsState.autoplay = document.getElementById('tts-autoplay-switch').checked;
                await db.ttsSettings.put({ id: 'main', ...ttsState });
                alert('API与语音设置已保存!'); 
            });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { const url = document.getElementById('proxy-url').value.trim(); const key = document.getElementById('api-key').value.trim(); if (!url || !key) return alert('请先填写反代地址和密钥'); try { const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) throw new Error('无法获取模型列表'); const data = await response.json(); const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = ''; data.data.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; if(model.id === state.apiConfig.model) option.selected = true; modelSelect.appendChild(option); }); alert('模型列表已更新'); } catch (error) { alert(`拉取模型失败: ${error.message}`); } });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('创建世界书', '请输入书名'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('书名不能为空！'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('照片描述', description); return; } const voiceMessage = e.target.closest('.voice-message-body'); if (voiceMessage) { const text = voiceMessage.dataset.text; if (text) showCustomAlert('语音内容', text); return; } });
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- 点击选择 --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `已选择 ${checkedBoxes.length} 项`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }           
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });
            document.getElementById('chat-settings-btn').addEventListener('click', async () => {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                const isGroup = chat.isGroup;
                document.getElementById('chat-name-group').style.display = 'block';
                document.getElementById('my-persona-group').style.display = 'block';
                document.getElementById('my-avatar-group').style.display = 'block';
                document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
                document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
                document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
                document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
                document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
                document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
                document.getElementById('chat-name-input').value = chat.name;
                document.getElementById('my-persona').value = chat.settings.myPersona;
                document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
                document.getElementById('max-memory').value = chat.settings.maxMemory;
                const bgPreview = document.getElementById('bg-preview');
                const removeBgBtn = document.getElementById('remove-bg-btn');
                if (chat.settings.background) {
                    bgPreview.src = chat.settings.background;
                    bgPreview.style.display = 'block';
                    removeBgBtn.style.display = 'inline-block';
                } else {
                    bgPreview.style.display = 'none';
                    removeBgBtn.style.display = 'none';
                }
                if (isGroup) {
                    document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
                    document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
                    renderGroupMemberSettings(chat.members);
                } else {
                    document.getElementById('ai-persona').value = chat.settings.aiPersona;
                    document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
                    const select = document.getElementById('assign-group-select');
                    select.innerHTML = '<option value="">未分组</option>';
                    const groups = await db.qzoneGroups.toArray();
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        if (chat.groupId === group.id) { option.selected = true; }
                        select.appendChild(option);
                    });
                }
                const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
                worldBookCheckboxesContainer.innerHTML = '';
                const linkedIds = chat.settings.linkedWorldBookIds || [];
                if (state.worldBooks.length > 0) {
                    state.worldBooks.forEach(book => {
                        const isChecked = linkedIds.includes(book.id);
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                        worldBookCheckboxesContainer.appendChild(label);
                    });
                }
                updateWorldBookSelectionDisplay();
                const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
                if (themeRadio) themeRadio.checked = true;
                const fontSizeSlider = document.getElementById('font-size-slider');
                fontSizeSlider.value = chat.settings.fontSize || 13;
                document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
                const customCssInput = document.getElementById('custom-css-input');
                customCssInput.value = chat.settings.customCss || '';
                updateSettingsPreview(); 
                document.getElementById('chat-settings-modal').classList.add('visible');
            });
            function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                const newName = document.getElementById('chat-name-input').value.trim();
                if (!newName) return alert('备注名/群名不能为空！');
                chat.name = newName;
                const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
                chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
                chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
                chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
                chat.settings.myPersona = document.getElementById('my-persona').value;
                chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
                const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
                chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);
                if (chat.isGroup) {
                    chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
                    chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
                } else {
                    chat.settings.aiPersona = document.getElementById('ai-persona').value;
                    chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
                    const selectedGroupId = document.getElementById('assign-group-select').value;
                    chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
                }
                chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
                await db.chats.put(chat);
                applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
                chatSettingsModal.classList.remove('visible');
                renderChatInterface(state.activeChatId);
                renderChatList();
            });
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('清空聊天记录', '此操作将永久删除此聊天的所有消息，无法恢复。确定要清空吗？', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });
            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("添加表情(URL)", "请输入表情包的图片URL"); if (!url || !url.trim().startsWith('http')) return url && alert("请输入有效的URL (以http开头)"); const name = await showCustomPrompt("命名表情", "请为这个表情命名 (例如：开心、疑惑)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("表情名不能为空！"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("命名表情", "请为这个表情命名 (例如：好耶、疑惑)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("表情名不能为空！"); }; event.target.value = null; });
            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("发送语音", "请输入你想说的内容："); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("发送照片", "请用文字描述您要发送的照片："); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
            document.getElementById('selection-delete-btn').addEventListener('click', async () => { if (selectedMessages.size === 0) return; const confirmed = await showCustomConfirm('删除消息', `确定要删除选中的 ${selectedMessages.size} 条消息吗？`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { const chat = state.chats[state.activeChatId]; chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp)); await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); } });
            document.getElementById('chat-settings-modal').addEventListener('click', (e) => { if (e.target.classList.contains('change-frame-btn')) { openFrameSelectorModal('chat'); } });
            document.getElementById('member-settings-modal').addEventListener('click', (e) => { if (e.target.classList.contains('change-frame-btn')) { openFrameSelectorModal('member'); } });
            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => { const newFontUrl = fontUrlInput.value.trim(); if (!newFontUrl) { alert("请输入有效的字体URL。"); return; } applyCustomFont(newFontUrl, false); state.globalSettings.fontUrl = newFontUrl; await db.globalSettings.put(state.globalSettings); alert('字体已保存并应用！'); });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("修改昵称", "请输入新的昵称", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
                resetCreatePostModal();
                const modal = document.getElementById('create-post-modal');
                modal.dataset.mode = 'shuoshuo';
                modal.querySelector('.post-mode-switcher').style.display = 'none';
                modal.querySelector('#image-mode-content').style.display = 'none';
                modal.querySelector('#text-image-mode-content').style.display = 'none';
                modal.querySelector('#post-public-text').placeholder = '分享新鲜事...';
                const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
                visibilityGroupsContainer.innerHTML = '';
                const groups = await db.qzoneGroups.toArray();
                if (groups.length > 0) {
                    groups.forEach(group => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                        visibilityGroupsContainer.appendChild(label);
                    });
                } else {
                    visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">没有可用的分组</p>';
                }
                modal.classList.add('visible');
            });
            document.getElementById('create-post-btn').addEventListener('click', async () => {
                resetCreatePostModal();
                const modal = document.getElementById('create-post-modal');
                modal.dataset.mode = 'complex';
                modal.querySelector('.post-mode-switcher').style.display = 'flex';
                modal.querySelector('#image-mode-content').style.display = 'block';
                modal.querySelector('#post-public-text').placeholder = '分享新鲜事...（非必填的公开文字）';
                const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
                visibilityGroupsContainer.innerHTML = '';
                const groups = await db.qzoneGroups.toArray();
                if (groups.length > 0) {
                    groups.forEach(group => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                        visibilityGroupsContainer.appendChild(label);
                    });
                } else {
                    visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">没有可用的分组</p>';
                }
                modal.classList.add('visible');
            });
            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });
            document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("创建新相册", "请输入相册名称"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`相册 "${albumName}" 创建成功！`); } else if (albumName !== null) { alert("相册名称不能为空！"); } });
            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("输入图片URL", "请输入网络图片的链接", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });
            document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
                const modal = document.getElementById('create-post-modal');
                const mode = modal.dataset.mode;
                const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
                let visibleGroupIds = null;
                if (visibilityMode === 'include') {
                    visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
                }
                let newPost = {};
                const basePostData = { timestamp: Date.now(), authorId: 'user', visibleGroupIds: visibleGroupIds, };
                if (mode === 'shuoshuo') {
                    const content = document.getElementById('post-public-text').value.trim();
                    if (!content) { alert('说说内容不能为空哦！'); return; }
                    newPost = { ...basePostData, type: 'shuoshuo', content: content, };
                } else {
                    const publicText = document.getElementById('post-public-text').value.trim();
                    const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
                    if (isImageModeActive) {
                        const imageUrl = document.getElementById('post-image-preview').src;
                        const imageDescription = document.getElementById('post-image-description').value.trim();
                        if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) { alert('请先添加一张图片再发布动态哦！'); return; }
                        if (!imageDescription) { alert('请为你的图片添加一个简单的描述（必填，给AI看的）！'); return; }
                        newPost = { ...basePostData, type: 'image_post', publicText: publicText, imageUrl: imageUrl, imageDescription: imageDescription, };
                    } else {
                        const hiddenText = document.getElementById('post-hidden-text').value.trim();
                        if (!hiddenText) { alert('请输入文字图描述！'); return; }
                        newPost = { ...basePostData, type: 'text_image', publicText: publicText, hiddenContent: hiddenText, };
                    }
                }
                const newPostId = await db.qzonePosts.add(newPost);
                let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "（无文字内容）";
                postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');
                for (const chatId in state.chats) {
                    const chat = state.chats[chatId];
                    if (chat.isGroup) continue;
                    let shouldNotify = false;
                    const postVisibleGroups = newPost.visibleGroupIds;
                    if (!postVisibleGroups || postVisibleGroups.length === 0) {
                        shouldNotify = true;
                    } 
                    else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
                        shouldNotify = true;
                    }
                    if (shouldNotify) {
                        const historyMessage = { role: 'system', content: `[系统提示：用户刚刚发布了一条动态(ID: ${newPostId})，内容摘要是：“${postSummary}”。你现在可以对这条动态进行评论了。]`, timestamp: Date.now(), isHidden: true };
                        chat.history.push(historyMessage);
                        await db.chats.put(chat);
                    }
                }
                await renderQzonePosts();
                modal.classList.remove('visible');
                alert('动态发布成功！');
            });
            const postsList = document.getElementById('qzone-posts-list');
            let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };
            function resetAllSwipes(exceptThisOne = null) { document.querySelectorAll('.qzone-post-container').forEach(container => { if (container !== exceptThisOne) container.querySelector('.qzone-post-item').classList.remove('swiped'); }); }
            const handleSwipeStart = (e) => { const targetContainer = e.target.closest('.qzone-post-container'); if (!targetContainer) return; resetAllSwipes(targetContainer); swipeState.activeContainer = targetContainer; swipeState.isDragging = true; swipeState.isClick = true; swipeState.swipeDirection = null; swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX; swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY; swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none'; };
            const handleSwipeMove = (e) => { if (!swipeState.isDragging || !swipeState.activeContainer) return; const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX; const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY; const diffX = currentX - swipeState.startX; const diffY = currentY - swipeState.startY; const absDiffX = Math.abs(diffX); const absDiffY = Math.abs(diffY); const clickThreshold = 5; if (absDiffX > clickThreshold || absDiffY > clickThreshold) swipeState.isClick = false; if (swipeState.swipeDirection === null) { if (absDiffX > clickThreshold || absDiffY > clickThreshold) { if (absDiffX > absDiffY) swipeState.swipeDirection = 'horizontal'; else swipeState.swipeDirection = 'vertical'; } } if (swipeState.swipeDirection === 'vertical') { handleSwipeEnd(e); return; } if (swipeState.swipeDirection === 'horizontal') { e.preventDefault(); swipeState.currentX = currentX; let translation = diffX; if (translation > 0) translation = 0; if (translation < -90) translation = -90; swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`; } };
            const handleSwipeEnd = (e) => { if (swipeState.isClick) { swipeState.isDragging = false; swipeState.activeContainer = null; return; } if (!swipeState.isDragging || !swipeState.activeContainer) return; const postItem = swipeState.activeContainer.querySelector('.qzone-post-item'); postItem.style.transition = 'transform 0.3s ease'; const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX; const diffX = finalX - swipeState.startX; const swipeThreshold = -40; if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) { postItem.classList.add('swiped'); postItem.style.transform = ''; } else { postItem.classList.remove('swiped'); postItem.style.transform = ''; } swipeState.isDragging = false; swipeState.startX = 0; swipeState.startY = 0; swipeState.currentX = 0; swipeState.activeContainer = null; swipeState.swipeDirection = null; swipeState.isClick = true; };
            postsList.addEventListener('mousedown', handleSwipeStart);
            document.addEventListener('mousemove', handleSwipeMove);
            document.addEventListener('mouseup', handleSwipeEnd);
            postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
            postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
            postsList.addEventListener('touchend', handleSwipeEnd);
            postsList.addEventListener('click', async (e) => {
                e.stopPropagation();
                const target = e.target;
                if (target.classList.contains('post-actions-btn')) {
                    const container = target.closest('.qzone-post-container');
                    if (container && container.dataset.postId) { showPostActions(parseInt(container.dataset.postId)); }
                    return; 
                }
                if (target.closest('.qzone-post-delete-action')) {
                    const container = target.closest('.qzone-post-container');
                    if (!container) return;
                    const postIdToDelete = parseInt(container.dataset.postId);
                    if (isNaN(postIdToDelete)) return;
                    const confirmed = await showCustomConfirm('删除动态', '确定要永久删除这条动态吗？', { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        container.style.transition = 'all 0.3s ease';
                        container.style.transform = 'scale(0.8)';
                        container.style.opacity = '0';
                        setTimeout(async () => {
                             await db.qzonePosts.delete(postIdToDelete);
                             const notificationIdentifier = `(ID: ${postIdToDelete})`;
                             for (const chatId in state.chats) {
                                 const chat = state.chats[chatId];
                                 const originalHistoryLength = chat.history.length;
                                 chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                                 if (chat.history.length < originalHistoryLength) {
                                     await db.chats.put(chat);
                                 }
                             }
                             await renderQzonePosts();
                             alert('动态已删除。');
                        }, 300);
                    }
                    return;
                }
                if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                    const hiddenText = target.dataset.hiddenText;
                    showCustomAlert("图片内容", hiddenText.replace(/<br>/g, '\n'));
                    return;
                }
                const icon = target.closest('.action-icon');
                if (icon) {
                    const postContainer = icon.closest('.qzone-post-container');
                    if (!postContainer) return;
                    const postId = parseInt(postContainer.dataset.postId);
                    if (isNaN(postId)) return;
                    if (icon.classList.contains('like')) {
                        const post = await db.qzonePosts.get(postId);
                        if (!post) return;
                        if (!post.likes) post.likes = [];
                        const userNickname = state.qzoneSettings.nickname;
                        const userLikeIndex = post.likes.indexOf(userNickname);
                        if (userLikeIndex > -1) {
                            post.likes.splice(userLikeIndex, 1);
                        } else {
                            post.likes.push(userNickname);
                            icon.classList.add('animate-like');
                            icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
                        }
                        await db.qzonePosts.update(postId, { likes: post.likes });
                    }
                    if (icon.classList.contains('favorite')) {
                        const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
                        if (existingFavorite) {
                            await db.favorites.delete(existingFavorite.id);
                            await showCustomAlert('提示', '已取消收藏');
                        } else {
                            const postToSave = await db.qzonePosts.get(postId);
                            if (postToSave) {
                                await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                                await showCustomAlert('提示', '收藏成功！');
                            }
                        }
                    }
                    await renderQzonePosts();
                    return;
                }
                const sendBtn = target.closest('.comment-send-btn');
                if (sendBtn) {
                    const postContainer = sendBtn.closest('.qzone-post-container');
                    if (!postContainer) return;
                    const postId = parseInt(postContainer.dataset.postId);
                    const commentInput = postContainer.querySelector('.comment-input');
                    const commentText = commentInput.value.trim();
                    if (!commentText) return alert('评论内容不能为空哦！');
                    const post = await db.qzonePosts.get(postId);
                    if (!post) return;
                    if (!post.comments) post.comments = [];
                    post.comments.push({ commenterName: state.qzoneSettings.nickname, text: commentText, timestamp: Date.now() });
                    await db.qzonePosts.update(postId, { comments: post.comments });
                    for (const chatId in state.chats) {
                        const chat = state.chats[chatId];
                        if (!chat.isGroup) {
                            chat.history.push({ role: 'system', content: `[系统提示：'${state.qzoneSettings.nickname}' 在ID为${postId}的动态下发表了评论：“${commentText}”]`, timestamp: Date.now(), isHidden: true });
                            await db.chats.put(chat);
                        }
                    }
                    commentInput.value = '';
                    await renderQzonePosts();
                    return;
                }
            });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';
                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems);
                    return;
                }
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';
                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || '我') : '我';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    return contentToSearch.toLowerCase().includes(searchTerm) || authorToSearch.toLowerCase().includes(searchTerm);
                });
                displayFilteredFavorites(filteredItems);
            });
            searchClearBtn.addEventListener('click', () => { searchInput.value = ''; searchClearBtn.style.display = 'none'; displayFilteredFavorites(allFavoriteItems); searchInput.focus(); });
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;
                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];
                for (const timestamp of timestampsToFavorite) {
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({ type: 'chat_message', content: messageToSave, chatId: state.activeChatId, timestamp: Date.now(), originalTimestamp: messageToSave.timestamp });
                        }
                    }
                }
                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
                    await showCustomAlert('收藏成功', `已成功收藏 ${favoritesToAdd.length} 条消息。`);
                } else {
                    await showCustomAlert('提示', '选中的消息均已收藏过。');
                }
                exitSelectionMode();
            });
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav');
            const favoritesList = document.getElementById('favorites-list');
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);
                if (isFavoritesSelectionMode) {
                    favoritesEditBtn.textContent = '完成';
                    favoritesActionBar.style.display = 'block';
                    mainBottomNav.style.display = 'none';
                    favoritesList.style.paddingBottom = '80px';
                } else {
                    favoritesEditBtn.textContent = '编辑';
                    favoritesActionBar.style.display = 'none';
                    mainBottomNav.style.display = 'flex';
                    favoritesList.style.paddingBottom = '';
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `删除 (0)`;
                }
            });
            document.getElementById('favorites-list').addEventListener('click', (e) => {
                const target = e.target;
                const card = target.closest('.favorite-item-card');
                if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                    const hiddenText = target.dataset.hiddenText;
                    showCustomAlert("图片内容", hiddenText.replace(/<br>/g, '\n'));
                    return;
                }
                if (!isFavoritesSelectionMode) return;
                if (!card) return;
                const favId = parseInt(card.dataset.favid);
                if (isNaN(favId)) return;
                if (selectedFavorites.has(favId)) {
                    selectedFavorites.delete(favId);
                    card.classList.remove('selected');
                } else {
                    selectedFavorites.add(favId);
                    card.classList.add('selected');
                }
                document.getElementById('favorites-delete-selected-btn').textContent = `删除 (${selectedFavorites.size})`;
            });
            document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
                if (selectedFavorites.size === 0) return;
                const confirmed = await showCustomConfirm('确认删除', `确定要从收藏夹中移除这 ${selectedFavorites.size} 条内容吗？`, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    const idsToDelete = [...selectedFavorites];
                    await db.favorites.bulkDelete(idsToDelete);
                    await showCustomAlert('删除成功', '选中的收藏已被移除。');
                    allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
                    displayFilteredFavorites(allFavoriteItems);
                    favoritesEditBtn.click();
                }
            });
            if (state.globalSettings.enableBackgroundActivity) { startBackgroundSimulation(); }
            document.querySelectorAll('input[name="theme-select"]').forEach(radio => { radio.addEventListener('change', updateSettingsPreview); });
            const fontSizeSlider = document.getElementById('font-size-slider');
            fontSizeSlider.addEventListener('input', () => { document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`; updateSettingsPreview(); });
            const customCssInputForPreview = document.getElementById('custom-css-input');
            customCssInputForPreview.addEventListener('input', updateSettingsPreview);
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; updateSettingsPreview(); });
            document.getElementById('reset-custom-css-btn').addEventListener('click', () => { document.getElementById('custom-css-input').value = ''; updateSettingsPreview(); });
            document.querySelectorAll('input[name="visibility"]').forEach(radio => { radio.addEventListener('change', function() { const groupsContainer = document.getElementById('post-visibility-groups'); if (this.value === 'include' || this.value === 'exclude') { groupsContainer.style.display = 'block'; } else { groupsContainer.style.display = 'none'; } }); });
            document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
            document.getElementById('close-group-manager-btn').addEventListener('click', () => { document.getElementById('group-management-modal').classList.remove('visible'); const chatSettingsBtn = document.getElementById('chat-settings-btn'); if (document.getElementById('chat-settings-modal').classList.contains('visible')) { chatSettingsBtn.click(); } });
            document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
            document.getElementById('existing-groups-list').addEventListener('click', (e) => { if (e.target.classList.contains('delete-group-btn')) { const groupId = parseInt(e.target.dataset.id); deleteGroup(groupId); } });
            document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
            document.getElementById('edit-message-btn').addEventListener('click', openMessageEditor);
            document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);
            document.getElementById('select-message-btn').addEventListener('click', () => { const timestampToSelect = activeMessageTimestamp; hideMessageActions(); if (timestampToSelect) { enterSelectionMode(timestampToSelect); } });
            document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
            document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
            document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);
            document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
            document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => { frameModal.classList.remove('visible'); editingFrameForMember = false; });
            aiFrameTab.addEventListener('click', () => { aiFrameTab.classList.add('active'); myFrameTab.classList.remove('active'); aiFrameContent.style.display = 'block'; myFrameContent.style.display = 'none'; });
            myFrameTab.addEventListener('click', () => { myFrameTab.classList.add('active'); aiFrameTab.classList.remove('active'); myFrameContent.style.display = 'block'; aiFrameContent.style.display = 'none'; });
            document.getElementById('tts-refresh-models-btn').addEventListener('click', async () => { await fetchTTSModels(); alert('语音模型列表已刷新。'); });
            document.getElementById('tts-settings-btn').addEventListener('click', openTTSSettingsPanel);
            document.getElementById('ephone-tts-settings-close').addEventListener('click', () => document.getElementById('ephone-tts-settings-panel').classList.remove('visible'));
            showScreen('home-screen');
        }
        init();
    });
</script>
</body>
</html>